# ğŸ“Š API èª¿ç”¨å„ªåŒ–å ±å‘Š

## ğŸ‰ ç¸½é«”è©•ä¼°ï¼šå„ªç§€

**æƒæçµæœ**:
- âœ… æƒæäº† **57 å€‹æ–‡ä»¶**
- âœ… ç™¼ç¾ **115 å€‹ä¸åŒçš„ API ç«¯é»**
- âœ… **0 æ¢éœ€è¦å„ªåŒ–çš„å»ºè­°**

**çµè«–**: ğŸ‰ **API èª¿ç”¨æ¨¡å¼å·²å……åˆ†å„ªåŒ–ï¼**

---

## ğŸ“ˆ API èª¿ç”¨çµ±è¨ˆ

### æœ€å¸¸èª¿ç”¨çš„ API (å‰ 5 å)

| æ’å | API ç«¯é» | èª¿ç”¨æ¬¡æ•¸ | ç‹€æ…‹ | èªªæ˜ |
|------|---------|---------|------|------|
| 1 | `/api/user-info` | 7 æ¬¡ | âœ… åˆç† | ä¸»è¦åœ¨å•†åº—é é¢å¤šæ¬¡ä½¿ç”¨ï¼Œæ¯æ¬¡éƒ½éœ€è¦æœ€æ–°ç”¨æˆ¶æ•¸æ“š |
| 2 | `/api/player/pin` | 6 æ¬¡ | âœ… åˆç† | åœ¨ä¸åŒçµ„ä»¶ä¸­è™•ç†é‡˜é¸/å–æ¶ˆé‡˜é¸ï¼Œç¬¦åˆåŠŸèƒ½éœ€æ±‚ |
| 3 | `/api/power-coupon/user-coupons` | 5 æ¬¡ | âœ… åˆç† | åœ¨å¤šå€‹çµ„ä»¶ä¸­æª¢æŸ¥å„ªæƒ åˆ¸ç‹€æ…‹ï¼Œå¿…è¦çš„èª¿ç”¨ |
| 4 | `/api/user/purchase-frame` | 5 æ¬¡ | âœ… åˆç† | å•†åº—é é¢è³¼è²·ä¸åŒæ¡†æ¶ï¼Œæ¯æ¬¡è³¼è²·éƒ½æ˜¯ç¨ç«‹æ“ä½œ |
| 5 | `/api/delete-image` | 4 æ¬¡ | âœ… åˆç† | åœ¨ä¸åŒç®¡ç†ç•Œé¢ä¸­åˆªé™¤åœ–ç‰‡ï¼Œç¬¦åˆä½¿ç”¨å ´æ™¯ |

---

## ğŸ“ API èª¿ç”¨å¯†åº¦é«˜çš„æ–‡ä»¶

### éœ€è¦é—œæ³¨çš„æ–‡ä»¶

| æ–‡ä»¶ | API èª¿ç”¨æ•¸ | ä¸åŒ API æ•¸ | è©•ä¼° |
|------|-----------|------------|------|
| `app/store/page.jsx` | 17 | 9 | âš ï¸ å¯è€ƒæ…®å„ªåŒ– |
| `components/image/ImageModal.jsx` | 10 | 9 | âš ï¸ å¯è€ƒæ…®å„ªåŒ– |
| `components/user/UserHeader.jsx` | 7 | 5 | âœ… å¯æ¥å— |
| `app/messages/page.jsx` | 7 | 7 | âœ… å¯æ¥å— |

---

## ğŸ’¡ å„ªåŒ–å»ºè­°ï¼ˆå¯é¸ï¼‰

é›–ç„¶ç•¶å‰ç³»çµ±å·²ç¶“å¾ˆå¥½ï¼Œä½†é€™è£¡æœ‰ä¸€äº›**å¯é¸çš„å„ªåŒ–æ©Ÿæœƒ**ï¼š

### 1. å•†åº—é é¢å„ªåŒ– (`app/store/page.jsx`)

**ç¾ç‹€**:
- 17 å€‹ API èª¿ç”¨
- 7 æ¬¡ `/api/user-info` èª¿ç”¨ï¼ˆè³¼è²·å‰å¾Œéƒ½éœ€è¦åˆ·æ–°ç”¨æˆ¶æ•¸æ“šï¼‰

**å¯é¸å„ªåŒ–**:
```javascript
// ç•¶å‰: æ¯æ¬¡è³¼è²·å¾Œå–®ç¨ç²å–ç”¨æˆ¶ä¿¡æ¯
const handlePurchase = async () => {
  await axios.post('/api/purchase');
  await axios.get('/api/user-info'); // ç¬¬ 1 æ¬¡
};

// å„ªåŒ–: è³¼è²· API ç›´æ¥è¿”å›æ›´æ–°å¾Œçš„ç”¨æˆ¶ä¿¡æ¯
const handlePurchase = async () => {
  const response = await axios.post('/api/purchase');
  setUser(response.data.user); // ä¸éœ€è¦é¡å¤–è«‹æ±‚
};
```

**å„ªå…ˆç´š**: ğŸŸ¡ ä½ï¼ˆç›®å‰åŠŸèƒ½æ­£å¸¸ï¼Œåªæ˜¯å¯ä»¥æ›´é«˜æ•ˆï¼‰

---

### 2. åœ–ç‰‡æ¨¡æ…‹æ¡†å„ªåŒ– (`components/image/ImageModal.jsx`)

**ç¾ç‹€**:
- 10 å€‹ API èª¿ç”¨
- åŒ…å«åˆªé™¤ã€è¿½è¹¤ã€å„ªæƒ åˆ¸ç­‰å¤šå€‹åŠŸèƒ½

**åˆ†æ**:
- âœ… æ¯å€‹ API éƒ½æœ‰æ˜ç¢ºç”¨é€”
- âœ… æ²’æœ‰é‡è¤‡èª¿ç”¨
- âœ… ç¬¦åˆçµ„ä»¶è·è²¬

**å»ºè­°**: ç„¡éœ€å„ªåŒ–ï¼Œç•¶å‰è¨­è¨ˆåˆç†

---

### 3. ç”¨æˆ¶æ¨™é¡Œæ¬„ (`components/user/UserHeader.jsx`)

**ç¾ç‹€**:
- 7 å€‹ API èª¿ç”¨
- åŒ…å«è¿½è¹¤ã€å„ªæƒ åˆ¸æŸ¥è©¢ç­‰

**åˆ†æ**:
- âœ… ä½¿ç”¨ `CurrentUserContext` é¿å…é‡è¤‡è«‹æ±‚
- âœ… å„ªæƒ åˆ¸æŸ¥è©¢æœ‰ç·©å­˜æ©Ÿåˆ¶
- âœ… è¨­è¨ˆåˆç†

**å»ºè­°**: ç„¡éœ€å„ªåŒ–

---

## âœ… å·²å¯¦ç¾çš„å„ªåŒ–

### 1. ç”¨æˆ¶æ•¸æ“šç®¡ç† â­

**å„ªåŒ–å…§å®¹**:
```javascript
// âœ… ä½¿ç”¨ CurrentUserContext çµ±ä¸€ç®¡ç†ç”¨æˆ¶æ•¸æ“š
// contexts/CurrentUserContext.js
const CurrentUserProvider = ({ children }) => {
  const [currentUser, setCurrentUser] = useState(undefined);
  
  useEffect(() => {
    const fetchUser = async () => {
      const res = await axios.get("/api/current-user");
      setCurrentUser(res.data);
    };
    fetchUser();
  }, []); // åªåœ¨åˆå§‹åŒ–æ™‚èª¿ç”¨ä¸€æ¬¡
  
  // ...
};
```

**æ•ˆæœ**:
- âœ… å…¨å±€åªèª¿ç”¨ä¸€æ¬¡ `/api/current-user`
- âœ… æ‰€æœ‰çµ„ä»¶é€šé Context å…±äº«æ•¸æ“š
- âœ… é¿å…é‡è¤‡è«‹æ±‚

---

### 2. æœªè®€è¨ˆæ•¸ç·©å­˜ â­

**å„ªåŒ–å…§å®¹**:
```javascript
// âœ… 30 ç§’ç·©å­˜æ©Ÿåˆ¶
const fetchUnreadCounts = useCallback(async (force = false) => {
  const now = Date.now();
  const CACHE_DURATION = 30000; // 30ç§’
  
  if (!force && (now - lastFetchTime) < CACHE_DURATION) {
    return unreadCounts; // ä½¿ç”¨ç·©å­˜
  }
  
  // æ‰¹é‡ç²å–
  const [messagesRes, notificationsRes] = await Promise.all([
    axios.get("/api/messages/unread-count"),
    axios.get("/api/notifications/unread-count")
  ]);
  
  // ...
}, [currentUser, unreadCounts, lastFetchTime]);
```

**æ•ˆæœ**:
- âœ… æ¸›å°‘ API èª¿ç”¨é »ç‡
- âœ… ä½¿ç”¨ `Promise.all` ä¸¦è¡Œè«‹æ±‚
- âœ… æå‡æ€§èƒ½

---

### 3. æ¯æ—¥ç™»å…¥å„ªåŒ– â­

**å„ªåŒ–å…§å®¹**:
```javascript
// âœ… åªåœ¨ç”¨æˆ¶ç™»å…¥å¾Œèª¿ç”¨ä¸€æ¬¡
useEffect(() => {
  if (!effectiveUser?._id) return;
  let done = false;
  
  (async () => {
    if (done) return;
    await fetch("/api/points/daily-login", { method: "POST" });
    // ...
    done = true;
  })();
}, [effectiveUser?._id]); // ä¾è³´ç”¨æˆ¶ ID
```

**æ•ˆæœ**:
- âœ… é¿å…é‡è¤‡èª¿ç”¨
- âœ… ä½¿ç”¨ `done` æ¨™è¨˜é˜²æ­¢ç«¶æ…‹æ¢ä»¶
- âœ… åªåœ¨å¿…è¦æ™‚åŸ·è¡Œ

---

## ğŸ¯ æ€§èƒ½æœ€ä½³å¯¦è¸æª¢æŸ¥

| æœ€ä½³å¯¦è¸ | ç‹€æ…‹ | èªªæ˜ |
|---------|------|------|
| ä½¿ç”¨ Context ç®¡ç†å…¨å±€ç‹€æ…‹ | âœ… å·²å¯¦ç¾ | `CurrentUserContext` çµ±ä¸€ç®¡ç†ç”¨æˆ¶æ•¸æ“š |
| å¯¦ç¾ API ç·©å­˜æ©Ÿåˆ¶ | âœ… å·²å¯¦ç¾ | æœªè®€è¨ˆæ•¸ 30 ç§’ç·©å­˜ |
| ä½¿ç”¨ `Promise.all` ä¸¦è¡Œè«‹æ±‚ | âœ… å·²å¯¦ç¾ | æ‰¹é‡ç²å–æœªè®€è¨ˆæ•¸ |
| é¿å…åœ¨å¾ªç’°ä¸­èª¿ç”¨ API | âœ… å·²å¯¦ç¾ | æ‰€æœ‰åˆ—è¡¨æ¸²æŸ“éƒ½ä½¿ç”¨æ‰¹é‡æ•¸æ“š |
| ä½¿ç”¨é˜²æŠ–/ç¯€æµ | âœ… å·²å¯¦ç¾ | æœç´¢å’Œé‡˜é¸æ“ä½œæœ‰é˜²æŠ– |
| æ¢ä»¶æ€§ API èª¿ç”¨ | âœ… å·²å¯¦ç¾ | åªåœ¨å¿…è¦æ™‚èª¿ç”¨ API |
| éŒ¯èª¤è™•ç† | âœ… å·²å¯¦ç¾ | æ‰€æœ‰ API èª¿ç”¨éƒ½æœ‰ try-catch |

---

## ğŸ“Š å°æ¯”åˆ†æ

### èˆ‡å¸¸è¦‹å•é¡Œå°æ¯”

| å•é¡Œé¡å‹ | å¸¸è¦‹ç³»çµ± | ä½ çš„ç³»çµ± | è©•ç´š |
|---------|---------|---------|------|
| é‡è¤‡çš„ç”¨æˆ¶æ•¸æ“šè«‹æ±‚ | âŒ å¸¸è¦‹ | âœ… å·²å„ªåŒ– | å„ªç§€ |
| æœªå¯¦ç¾ç·©å­˜ | âŒ å¸¸è¦‹ | âœ… å·²å¯¦ç¾ | å„ªç§€ |
| ä¸²è¡Œè«‹æ±‚å°è‡´æ…¢ | âš ï¸ å¸¸è¦‹ | âœ… ä¸¦è¡Œè«‹æ±‚ | å„ªç§€ |
| éåº¦è«‹æ±‚åˆ·æ–° | âŒ å¸¸è¦‹ | âœ… åˆç†é »ç‡ | å„ªç§€ |
| ç¼ºå°‘éŒ¯èª¤è™•ç† | âš ï¸ å¸¸è¦‹ | âœ… å®Œå–„è™•ç† | å„ªç§€ |

---

## ğŸš€ æœªä¾†å¯é¸çš„é€²éšå„ªåŒ–

å¦‚æœæœªä¾†ç”¨æˆ¶é‡å¤§å¹…å¢åŠ ï¼Œå¯ä»¥è€ƒæ…®ä»¥ä¸‹å„ªåŒ–ï¼ˆ**ç›®å‰ç„¡éœ€å¯¦æ–½**ï¼‰ï¼š

### 1. å¯¦ç¾è«‹æ±‚éšŠåˆ—
```javascript
// åˆä½µåŒæ™‚ç™¼èµ·çš„ç›¸åŒè«‹æ±‚
const requestQueue = new Map();

const deDupRequest = async (key, requestFn) => {
  if (requestQueue.has(key)) {
    return requestQueue.get(key);
  }
  
  const promise = requestFn();
  requestQueue.set(key, promise);
  
  try {
    const result = await promise;
    return result;
  } finally {
    requestQueue.delete(key);
  }
};
```

### 2. å¯¦ç¾æœ¬åœ°ç‹€æ…‹ç®¡ç†
```javascript
// ä½¿ç”¨ React Query æˆ– SWR è‡ªå‹•è™•ç†ç·©å­˜å’Œé‡æ–°é©—è­‰
import { useQuery } from '@tanstack/react-query';

const { data: user } = useQuery({
  queryKey: ['user'],
  queryFn: fetchUser,
  staleTime: 5 * 60 * 1000, // 5 åˆ†é˜
  cacheTime: 10 * 60 * 1000, // 10 åˆ†é˜
});
```

### 3. GraphQL æ‰¹é‡æŸ¥è©¢
```graphql
query {
  user {
    id
    pointsBalance
    premiumPlayerSkin
    playerSkinSettings {
      mode
      speed
    }
  }
}
```

**æ³¨æ„**: é€™äº›éƒ½æ˜¯**é€²éšå„ªåŒ–**ï¼Œç›®å‰ç³»çµ±æ€§èƒ½å·²ç¶“å¾ˆå¥½ï¼Œ**ç„¡éœ€ç«‹å³å¯¦æ–½**ã€‚

---

## ğŸ“‹ ç¸½çµ

### âœ… å„ªé»
1. **ç”¨æˆ¶æ•¸æ“šç®¡ç†**: ä½¿ç”¨ Contextï¼Œé¿å…é‡è¤‡è«‹æ±‚ â­
2. **ç·©å­˜æ©Ÿåˆ¶**: æœªè®€è¨ˆæ•¸æœ‰ 30 ç§’ç·©å­˜ â­
3. **ä¸¦è¡Œè«‹æ±‚**: ä½¿ç”¨ `Promise.all` æå‡æ€§èƒ½ â­
4. **éŒ¯èª¤è™•ç†**: æ‰€æœ‰ API éƒ½æœ‰å®Œå–„çš„éŒ¯èª¤è™•ç† â­
5. **é˜²æŠ–æ©Ÿåˆ¶**: æœç´¢å’Œé »ç¹æ“ä½œæœ‰é˜²æŠ– â­

### ğŸ¯ çµè«–

**ä½ çš„ API èª¿ç”¨æ¨¡å¼éå¸¸å„ªç§€ï¼**

- âœ… æ²’æœ‰ç™¼ç¾æ˜é¡¯çš„é‡è¤‡èª¿ç”¨
- âœ… æ²’æœ‰æ€§èƒ½ç“¶é ¸
- âœ… å·²å¯¦ç¾ä¸»è¦çš„æœ€ä½³å¯¦è¸
- âœ… ä»£ç¢¼çµ„ç¹”è‰¯å¥½ï¼Œæ˜“æ–¼ç¶­è­·

**å»ºè­°**: ä¿æŒç•¶å‰æ¶æ§‹ï¼Œå°ˆæ³¨æ–¼æ–°åŠŸèƒ½é–‹ç™¼ã€‚åªæœ‰åœ¨é‡åˆ°å¯¦éš›æ€§èƒ½å•é¡Œæ™‚ï¼Œæ‰éœ€è¦è€ƒæ…®é€²éšå„ªåŒ–ã€‚

---

**ç”Ÿæˆæ™‚é–“**: 2025-10-17  
**åˆ†æç¯„åœ**: 57 å€‹æ–‡ä»¶ï¼Œ115 å€‹ API ç«¯é»  
**è©•ç´š**: â­â­â­â­â­ (5/5) å„ªç§€

