# 📋 訂閱系統使用指南

## 🎯 系統概述

釘選播放器現已整合到積分訂閱系統中，形成完整的積分循環生態。

---

## 💰 積分循環生態

### 獲得積分（免費）
- ✅ 每日登入：10 積分
- ✅ 上傳圖片：20 積分
- ✅ 圖片被點贊：5 積分
- ✅ 評論：2 積分
- ✅ 發討論帖：10 積分
- ✅ 等級提升：獎勵積分

### 消耗積分
- 💎 頭像框：30-50 積分（一次性）
- 💎 調色盤功能：200 積分（一次性）
- 💎 **釘選播放器：100 積分/月（月租）** ← 新增
- 💎 權力券：30-100 積分
- 💎 上傳配額擴展：100 積分/10 張

---

## 🎵 釘選播放器訂閱

### 功能特點
- 📌 全站跨頁面播放
- 🎵 30 天有效期
- ✨ 支援自動續費
- 🔄 可隨時取消

### 定價
- **100 積分/月**
- 首次開通立即扣除 100 積分
- 30 天後自動續費（如果啟用自動續費）

---

## 🛒 購買流程

### 在積分商店購買

1. **前往積分商店** (`/store`)
2. **點擊「功能解鎖」分類**
3. **找到「釘選播放器（月租）」**
4. **（可選）勾選「✨ 啟用自動續費」**
   - 勾選：每月自動扣除 100 積分
   - 不勾選：30 天後需手動續費
5. **點擊「開通訂閱」**
6. **確認扣除 100 積分**

### 使用釘選功能

1. **前往任意用戶頁面**
2. **點擊播放器上的 📌 按鈕**
3. **確認釘選**
4. **全站持續播放！**

如果未訂閱，點擊 📌 按鈕時會提示：
```
釘選播放器需要訂閱才能使用。

💰 每月僅需 100 積分（可通過互動免費獲得）
✨ 支援自動續費

是否前往積分商店開通訂閱？
```

---

## ⚙️ 訂閱管理

### 在設置頁面管理

前往 `/settings`，可以：

#### 查看訂閱狀態
- 📦 訂閱項目列表
- 📅 下次扣款日期
- 💰 月費金額
- ✅ 自動續費狀態

#### 切換自動續費
- 點擊勾選框即可開啟/關閉
- 開啟：每月自動扣款
- 關閉：到期後需手動續費

#### 取消訂閱
- 點擊「取消訂閱」按鈕
- 確認後立即生效
- **釘選的播放器會自動解除**

---

## 🤖 自動續費機制

### 每日檢查（定時任務）

系統每天會自動執行 `scripts/process-subscriptions.js`，處理：

#### 1️⃣ 檢查到期訂閱
```
今天是扣款日？
├─ 是 → 檢查自動續費
└─ 否 → 跳過
```

#### 2️⃣ 自動續費判斷
```
有啟用自動續費？
├─ 是 → 檢查積分
│   ├─ 積分充足 → 扣款 + 續費 30 天
│   └─ 積分不足 → 取消訂閱 + 發通知
└─ 否 → 取消訂閱 + 發通知
```

#### 3️⃣ 釘選播放器特殊處理
```
取消訂閱時：
└─ 自動解除釘選播放器
```

### 通知系統
- ✅ 續費成功：發送通知
- ❌ 積分不足取消：發送通知
- ⚠️ 未啟用自動續費到期：發送通知

---

## 🧪 測試清單

### 完整流程測試

#### ✅ 測試 1：開通訂閱（有足夠積分）
1. 確保積分 ≥ 100
2. 前往商店，勾選自動續費
3. 點擊「開通訂閱」
4. 檢查：
   - [ ] 積分正確扣除 100
   - [ ] 訂閱狀態顯示「訂閱中」
   - [ ] 在設置頁面能看到訂閱
   - [ ] 可以成功釘選播放器

#### ✅ 測試 2：開通訂閱（積分不足）
1. 確保積分 < 100
2. 前往商店，點擊「開通訂閱」
3. 檢查：
   - [ ] 顯示錯誤提示「積分不足」
   - [ ] 積分未被扣除
   - [ ] 訂閱未創建

#### ✅ 測試 3：釘選權限檢查
1. **未訂閱時**：點擊 📌 按鈕
   - [ ] 顯示提示「需要訂閱」
   - [ ] 詢問是否前往商店
2. **已訂閱時**：點擊 📌 按鈕
   - [ ] 成功釘選
   - [ ] 跨頁面持續播放

#### ✅ 測試 4：自動續費開關
1. 在設置頁面切換自動續費
2. 檢查：
   - [ ] 勾選框狀態正確更新
   - [ ] 數據庫正確保存
   - [ ] 提示信息正確顯示

#### ✅ 測試 5：取消訂閱
1. 在設置或商店中取消訂閱
2. 檢查：
   - [ ] 訂閱狀態變為「已取消」
   - [ ] 釘選的播放器自動解除
   - [ ] 再次釘選時提示需要訂閱

#### ✅ 測試 6：自動扣款（需要手動觸發）
1. 修改訂閱的 `nextBillingDate` 為過去時間
2. 運行 `node scripts/process-subscriptions.js`
3. 檢查：
   - [ ] 有自動續費 + 積分充足 → 續費成功
   - [ ] 有自動續費 + 積分不足 → 取消訂閱
   - [ ] 無自動續費 → 取消訂閱

---

## 📊 數據結構

### User.subscriptions
```javascript
{
  type: 'pinPlayer',              // 訂閱類型
  startDate: Date,                // 開始日期
  nextBillingDate: Date,          // 下次扣款日期
  isActive: true,                 // 是否啟用
  autoRenew: true,                // 自動續費
  monthlyCost: 100,               // 月費
  cancelledAt: null               // 取消時間
}
```

---

## 🔧 管理員工具

### 手動處理訂閱扣款
```bash
node scripts/process-subscriptions.js
```

### 查看用戶訂閱狀態
```javascript
// MongoDB 查詢
db.users.find({ 
  'subscriptions.isActive': true 
}).pretty()
```

---

## ⚠️ 注意事項

1. **定時任務部署**
   - 部署到 Vercel 後，需要設置 Vercel Cron Jobs
   - 或使用外部定時任務服務（如 GitHub Actions）

2. **積分不足處理**
   - 自動取消訂閱
   - 發送通知提醒用戶
   - 如果是釘選播放器，自動解除釘選

3. **訂閱過期時間**
   - 釘選播放器的 `expiresAt` 與訂閱的 `nextBillingDate` 同步
   - 確保不會出現「訂閱有效但釘選已過期」的情況

---

## 🎯 公開前檢查清單

- [ ] 測試開通訂閱（有/無足夠積分）
- [ ] 測試自動續費開關
- [ ] 測試取消訂閱
- [ ] 測試釘選權限檢查
- [ ] 測試積分扣除記錄
- [ ] 測試通知發送
- [ ] 設置定時任務（生產環境）
- [ ] 清理調試日誌

---

## 📅 未來擴展

可以添加更多月租功能：
- 📤 上傳配額擴展（月租）
- 🎨 高級編輯功能（月租）
- 👑 VIP 會員（月租，包含多項功能）

只需在 `SUBSCRIPTION_CONFIG` 中添加配置即可！

