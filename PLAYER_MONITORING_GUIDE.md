# 🔍 播放器监测指南

> 用于调试和追踪播放器行为的日志系统

---

## 📊 监测功能清单

### 1. 播放进度监测 ⏱️
**位置：** `components/common/MiniPlayer.jsx`  
**频率：** 每 10 秒一次  
**日志格式：**
```
⏱️ [播放監測] {
  當前進度: "120秒",
  總時長: "240秒",
  進度百分比: "50%",
  音量: "75%",
  播放狀態: "播放中",
  當前曲目: "歌曲名稱",
  是否釘選: true
}
```

**用途：**
- 追踪播放进度是否正常更新
- 检查音量是否保持设定值
- 确认播放状态同步

---

### 2. 音量变化监测 🔊
**位置：** `components/player/GlobalYouTubeBridge.jsx`  
**触发：** 每次调用 `setVolume()` 时  
**日志格式：**
```
🔊 [音量監測] {
  設置音量: "75%",
  原始值: 0.75,
  視頻ID: "xxxxx"
}
```

**用途：**
- 追踪音量设置调用
- 检查音量值是否正确传递
- 诊断音量固定在 100% 的问题

---

### 3. YouTube 状态监测 🎬
**位置：** `components/player/GlobalYouTubeBridge.jsx`  
**触发：** 每次 YouTube 播放器状态改变时  
**日志格式：**
```
🎬 [YouTube狀態] {
  狀態: "PLAYING",
  視頻ID: "xxxxx",
  當前音量: 75,
  播放時間: 120
}
```

**状态码说明：**
- `UNSTARTED` (-1) - 未开始
- `ENDED` (0) - 播放结束
- `PLAYING` (1) - 播放中
- `PAUSED` (2) - 已暂停
- `BUFFERING` (3) - 缓冲中
- `CUED` (5) - 已加载

**用途：**
- 追踪 YouTube 播放器的完整生命周期
- 检查状态转换是否正常
- 诊断播放卡顿或异常

---

### 4. 播放结束监测 🎵
**位置：** `components/player/GlobalYouTubeBridge.jsx`  
**触发：** 歌曲播放结束时  
**日志格式：**
```
🎵 [播放結束] {
  視頻ID: "xxxxx",
  當前曲目: "歌曲名稱",
  歌單長度: 10,
  當前索引: 5,
  是否循環: false
}
```

**用途：**
- 确认歌曲正常播放完毕
- 检查是否触发下一首
- 追踪循环播放逻辑

---

### 5. 自动下一首监测 ⏭️
**位置：** `components/context/PlayerContext.js`  
**触发：** 调用 `next()` 时  
**日志格式：**
```
⏭️ [下一首監測] {
  當前索引: 5,
  下一首索引: 6,
  歌單長度: 10,
  是否循環: "否",
  下一首曲目: "下一首歌名",
  當前時間: "14:30:45"
}
```

**循环标识：**
```
是否循環: "✅ 是（回到第一首）"  // 当从最后一首跳到第一首时
```

**用途：**
- 追踪自动播放下一首的逻辑
- 检测循环播放是否正常
- 诊断歌单切换问题

---

### 6. 钉选事件监测 📌
**位置：** `components/player/PinPlayerButton.jsx`, `components/common/MiniPlayer.jsx`, `app/page.js`  
**触发：** 钉选/取消钉选时  
**日志格式：**
```
📌 [PinButton] 開始釘選
📌 [PinButton] API 回應
📡 [PinButton] 觸發事件
✅ [PinButton] 事件觸發完成

📡 [首頁] 收到釘選事件
✅ [首頁-event] 載入釘選歌單
🎵 [首頁-event] 當前曲目
✅ [首頁-event] 播放器設置完成

📡 [MiniPlayer] 收到釘選事件
🎵 [MiniPlayer-Event] 載入歌單
✅ [MiniPlayer-Event] 歌單設置完成
```

**用途：**
- 追踪钉选流程的完整生命周期
- 检查事件是否正确触发和接收
- 诊断钉选后播放器状态不同步问题

---

## 🎯 使用场景

### 场景 1：音量固定在 100%
**查看日志：** `🔊 [音量監測]`  
**检查项：**
- 是否有音量设置日志？
- 设置音量是多少？
- 是否被后续操作覆盖？

### 场景 2：歌曲不循环播放
**查看日志：** `⏭️ [下一首監測]`  
**检查项：**
- `是否循環` 字段的值
- 最后一首播放结束后的日志

### 场景 3：播放进度不更新
**查看日志：** `⏱️ [播放監測]`  
**检查项：**
- 每 10 秒是否有日志？
- 进度是否递增？
- 播放状态是否正确？

### 场景 4：钉选后首页显示"未设定音源"
**查看日志：** 钉选事件系列  
**检查项：**
- `📌 [PinButton] 事件觸發完成` 是否存在？
- `📡 [首頁] 收到釘選事件` 是否存在？
- `✅ [首頁-event] 播放器設置完成` 是否存在？

---

## 🔧 调试技巧

### 1. 过滤特定日志
浏览器控制台 Filter 输入：
- `播放監測` - 只看播放进度
- `音量監測` - 只看音量变化
- `下一首` - 只看切歌逻辑
- `釘選` - 只看钉选相关

### 2. 时间轴分析
按时间顺序查看日志，确认：
1. 事件触发顺序是否正确
2. 状态变化是否符合预期
3. 是否有异常的重复调用

### 3. 对比测试
- 本地环境 vs 生产环境
- 钉选模式 vs 个人页面模式
- 首次钉选 vs 刷新页面

---

## ⚠️ 常见问题

### 问题 1：日志过多影响性能
**解决：** 调试完成后可以注释掉不需要的日志

### 问题 2：看不到某些日志
**原因：** 条件未满足（例如不在播放状态，就不会输出播放监测）

### 问题 3：Object 显示不全
**解决：** 点击 Object 展开，或者在代码中使用 `JSON.stringify(obj, null, 2)`

---

*监测系统版本：v1.0*  
*最后更新：2025-10-14*

