# 💰 討論區積分提領系統 - 完整文檔

## ✅ 系統概述

**核心理念**：愛心代表認可，一旦給出就不可撤回獎勵

### 🎯 **積分流程**

```
發布多圖教學帖
    ↓
消耗積分（5或10）
    ↓
收到愛心 → 累積待領取積分
    ↓
用戶手動提領 → 獲得積分
    ↓
積分記錄（一條記錄）
```

---

## 📋 **完整規則**

### **1. 發帖消耗**

| 圖片數量 | 消耗積分 | 說明 |
|---------|---------|------|
| 0-1 張 | 0 | 免費 |
| 2-5 張 | **5** | 小型教學 |
| 6-9 張 | **10** | 完整教學 |

### **2. 愛心規則**

| 操作 | 待領取積分 | 說明 |
|------|-----------|------|
| 第一次點讚 | **+1** | 累積到 `pendingPoints` |
| 重複點讚 | **0** | 同一用戶只能貢獻1次 |
| 取消點讚 | **0** | 不扣除積分（認可不可撤回）|
| 自己點讚自己 | **0** | 防止作弊 |

### **3. 提領機制**

**單個帖子提領**：
- API: `POST /api/discussion/claim-points` + `{ postId: '...' }`
- 提領該帖子的 `pendingPoints`
- 生成一條積分記錄

**全部提領**：
- API: `POST /api/discussion/claim-points` + `{}`
- 提領所有多圖教學帖的 `pendingPoints`
- 生成一條積分記錄（包含所有帖子的詳情）

---

## 🗄️ **數據庫結構**

### **DiscussionPost 新增字段**

```javascript
{
  // 原有字段...
  imageCount: Number,          // 圖片數量
  pointsCost: Number,          // 發帖消耗的積分
  
  // 新增字段
  pendingPoints: Number,       // 待領取積分
  claimedPoints: Number,       // 已領取積分
  rewardedUsers: [ObjectId],   // 已獎勵過的用戶（防重複）
  lastClaimedAt: Date          // 最後提領時間
}
```

### **User 新增字段**

```javascript
{
  // 原有字段...
  pointsBalance: Number,
  totalEarnedPoints: Number,
  
  // 新增字段
  discussionPendingPoints: Number  // 所有帖子的總待領取積分
}
```

---

## 🎨 **UI 設計**

### **1. 帖子詳情頁（作者視角）**

```
┌──────────────────────────────────────┐
│ 📚 多圖教學帖收益                     │
│                                       │
│ 待領取            已領取              │
│ +23              +15                 │
│                                       │
│ 38 個愛心 · 消耗 5 積分    [提領積分] │
└──────────────────────────────────────┘
```

**顯示邏輯**：
- ✅ 只有作者可見
- ✅ 顯示待領取和已領取
- ✅ 有待領取時顯示提領按鈕
- ✅ 點擊提領按鈕 → 積分到賬

### **2. 用戶個人頁（自己的頁面）**

```
┌──────────────────────────────────────┐
│ 當前積分                              │
│ 1234                                 │
│                                       │
│ ┌────────────────────────────┐       │
│ │ 📚 討論區收益               │       │
│ │ +156 待領取        [提領]   │       │
│ └────────────────────────────┘       │
│                                       │
│ 本月獲得    總計獲得                  │
│ 50          1234                     │
└──────────────────────────────────────┘
```

**顯示邏輯**：
- ✅ 只在自己的頁面顯示
- ✅ 只在有待領取時顯示
- ✅ 點擊提領 → 一次領取所有帖子的收益

---

## 🔄 **完整案例**

### **案例：優質教學帖**

```
第1天：
  - 發布教學帖（3張圖）→ 消耗 5 積分
  - 收到 20 個愛心 → pendingPoints = 20
  - 用戶A重複點讚3次 → 只算1次
  - 實際 pendingPoints = 20（不是23）

第2天：
  - 再收到 10 個愛心 → pendingPoints = 30
  - 用戶提領 → pointsBalance +30
  - pendingPoints = 0, claimedPoints = 30
  - 積分記錄：1條「提領討論區收益 +30 積分」

第3天：
  - 5人取消愛心 → likesCount = 25
  - pendingPoints 和 claimedPoints 不變 ✅
  - 作者積分不受影響 ✅
```

---

## 🛡️ **防作弊機制**

### **1. 防止重複累積**
```javascript
// 使用 rewardedUsers 數組記錄已獎勵的用戶
if (post.rewardedUsers.includes(userId)) {
  // 不重複累積
  return;
}
```

### **2. 防止自己點讚自己**
```javascript
if (postAuthorId === currentUserId) {
  // 不累積積分
  return;
}
```

### **3. 愛心不可撤回積分**
```javascript
// 取消點讚時
post.removeLike(userId);
// ❌ 不扣除 pendingPoints
// ❌ 不扣除 author.discussionPendingPoints
```

---

## 📊 **積分記錄優化**

### **之前（每個愛心一條記錄）**：
```
1. discussion_like_reward +1 (用戶A點讚)
2. discussion_like_reward +1 (用戶B點讚)
3. discussion_like_reward +1 (用戶C點讚)
...
50. discussion_like_reward +1 (用戶Z點讚)
```
❌ 50條記錄

### **現在（提領時一條記錄）**：
```
1. discussion_post_cost -5 (發帖消耗)
2. discussion_like_reward +50 (提領收益，來自3個帖子)
```
✅ 2條記錄

---

## 🧪 **測試清單**

### **基礎功能**
- [ ] 發布多圖帖消耗積分
- [ ] 收到愛心累積 `pendingPoints`
- [ ] 重複點讚不重複累積
- [ ] 取消點讚不扣除積分
- [ ] 自己點讚自己不累積

### **提領功能**
- [ ] 單個帖子提領成功
- [ ] 全部帖子一鍵提領
- [ ] 提領後 `pendingPoints` 歸零
- [ ] 提領後 `claimedPoints` 增加
- [ ] 積分記錄正確生成

### **UI 顯示**
- [ ] 帖子詳情頁顯示待領取
- [ ] 用戶頁面顯示總待領取
- [ ] 提領按鈕正常工作
- [ ] 提領後UI更新

---

## 🚀 **使用方法**

### **作為創作者**：

1. **發布多圖教學帖**（消耗5-10積分）
2. **收到愛心**（自動累積待領取）
3. **查看收益**：
   - 帖子詳情頁：單個帖子的待領取
   - 個人頁面：所有帖子的總待領取
4. **提領積分**：
   - 單個提領：在帖子頁點擊「提領積分」
   - 全部提領：在個人頁點擊「提領」

### **作為讀者**：

1. **閱讀教學帖**
2. **點讚表達認可**（作者獲得積分獎勵）
3. **隨時可以取消點讚**（不影響作者）

---

## 💡 **優勢總結**

✅ **簡潔**：積分記錄不被洗版
✅ **公平**：認可不可撤回
✅ **靈活**：用戶自主提領
✅ **防作弊**：多重機制保護
✅ **激勵**：鼓勵優質教學內容

---

## 🎉 **系統完成！**

現在可以測試完整流程：

1. 發布多圖教學帖
2. 收到愛心（查看待領取增加）
3. 提領積分（查看積分到賬）
4. 查看積分記錄（簡潔清爽）

**所有功能已完成！** 🚀

