# 🔍 系統穩定性測試指南

## 📋 測試概覽

這套測試系統幫助你快速檢查系統的穩定性和資料完整性。

---

## 🧪 測試類型

### 1️⃣ 快速測試（推薦）

**一次執行所有測試**
```bash
node scripts/run-all-tests.js
```

這會依序執行：
- ✅ 資料完整性測試
- ✅ 播放器系統測試  
- ✅ 冒煙測試（需要伺服器運行）

**執行時間**: 約 30 秒 - 1 分鐘

---

### 2️⃣ 個別測試

#### 🔒 資料完整性測試
檢查資料庫數據的一致性

```bash
node scripts/data-integrity-test.js
```

**測試項目**:
- ✅ 用戶積分數據一致性
- ✅ 圖片愛心數據一致性
- ✅ 播放器造型數據完整性
- ✅ 資料庫統計

**適用時機**: 
- 每次修改資料庫結構後
- 懷疑數據不一致時
- 定期檢查（每週）

---

#### 🎵 播放器系統測試
測試播放器相關功能

```bash
node scripts/player-system-test.js
```

**測試項目**:
- ✅ 預設造型設置
- ✅ 已購買用戶造型數據
- ✅ 造型權限一致性
- ✅ 播放器使用統計

**適用時機**:
- 修改播放器功能後
- 新增播放器造型後
- 發現播放器顯示問題時

---

#### 🔥 冒煙測試
快速檢查核心功能

```bash
# ⚠️ 需要先啟動開發伺服器
npm run dev

# 然後在另一個終端執行
node scripts/smoke-test.js
```

**測試項目**:
- ✅ 首頁載入
- ✅ API 健康檢查
- ✅ 資料庫連接
- ✅ 播放器 API

**適用時機**:
- 每次部署前
- 修改核心 API 後
- 懷疑系統異常時

---

## 📊 測試結果解讀

### ✅ 所有測試通過
```
🎉 所有測試通過！系統穩定性良好
✅ 系統可以安全運行
```
**意義**: 系統運行正常，可以繼續開發新功能

---

### ⚠️ 有警告
```
⚠️ 發現 X 個警告
💡 可用 repairLikes 修復
```
**意義**: 系統基本正常，但有可優化項目
**建議**: 根據提示執行修復腳本

---

### ❌ 測試失敗
```
❌ 發現 X 個嚴重問題
⚠️ 建議立即修復
```
**意義**: 系統存在問題，可能影響功能
**建議**: 查看詳細錯誤信息，立即修復

---

## 🛠️ 常見問題修復

### 問題 1: 愛心數不一致
```bash
# 執行修復 API（乾跑模式，不修改數據）
curl "http://localhost:3000/api/images?repairLikes=1&dry=1"

# 確認無誤後執行實際修復
curl "http://localhost:3000/api/images?repairLikes=1"
```

### 問題 2: 用戶缺少預設造型
系統會在用戶登入時自動設置，無需手動修復

### 問題 3: 積分數據異常
請檢查 `PointsTransaction` 表，確認交易記錄正確

---

## 📅 建議測試頻率

| 測試類型 | 頻率 | 時機 |
|---------|------|------|
| 快速測試 | 每次部署前 | 發布新版本前 |
| 資料完整性測試 | 每週一次 | 定期維護 |
| 播放器系統測試 | 修改播放器後 | 功能更新後 |
| 冒煙測試 | 每天一次 | 每日開發開始前 |

---

## 💡 最佳實踐

### ✅ 開發流程
1. 修改代碼
2. 執行相關測試
3. 測試通過後提交
4. 部署前執行完整測試

### ✅ 問題排查
1. 發現問題後立即執行測試
2. 查看詳細錯誤信息
3. 根據提示修復
4. 重新執行測試確認修復

### ✅ 定期維護
1. 每週執行完整測試
2. 檢查警告項目
3. 優化可改進部分
4. 記錄測試結果

---

## 🚀 自動化建議

可以將測試加入 Git hooks：

```bash
# .git/hooks/pre-push
#!/bin/sh
echo "執行測試..."
node scripts/run-all-tests.js
```

或加入 CI/CD 流程：

```yaml
# .github/workflows/test.yml
- name: Run stability tests
  run: node scripts/run-all-tests.js
```

---

## 📞 支援

如果測試失敗且無法自行解決：
1. 查看測試輸出的詳細錯誤
2. 檢查相關代碼文件
3. 回溯最近的修改
4. 考慮回滾到上一個穩定版本

