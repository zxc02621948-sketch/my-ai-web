# åˆªé™¤ç•™è¨€èˆ‡ç†±é–€åº¦åˆ†æ•¸

> **ç¢ºèªæ—¥æœŸï¼š** 2025-10-22  
> **çµè«–ï¼š** âœ… åˆªé™¤ç•™è¨€æœƒè‡ªå‹•æ›´æ–°åœ–ç‰‡çš„ç†±é–€åº¦åˆ†æ•¸

---

## âœ… **ç¢ºèªçµæœ**

**åˆªé™¤ç•™è¨€æ™‚æœƒè‡ªå‹•ï¼š**
1. âœ… é‡æ–°è¨ˆç®—ç•™è¨€ç¸½æ•¸ (`commentsCount`)
2. âœ… é‡æ–°è¨ˆç®—ç†±é–€åº¦åˆ†æ•¸ (`popScore`)
3. âœ… åŒæ™‚åˆªé™¤æ‰€æœ‰å›è¦†ç•™è¨€
4. âœ… ä¿å­˜æ›´æ–°å¾Œçš„åœ–ç‰‡è³‡æ–™

---

## ğŸ”§ **å¯¦ç¾é‚è¼¯**

### **API ç«¯é»ï¼š**
```
DELETE /api/delete-comment/[commentId]
```

### **æ›´æ–°é‚è¼¯ï¼š**

```javascript
// app/api/delete-comment/[commentId]/route.js

// 1. åˆªé™¤æ‰€æœ‰å›è¦†ç•™è¨€
await Comment.deleteMany({ parentCommentId: commentId });

// 2. åˆªé™¤ä¸»ç•™è¨€
await Comment.findByIdAndDelete(commentId);

// 3. æ›´æ–°åœ–ç‰‡çš„ç•™è¨€æ•¸å’Œç†±é–€åº¦åˆ†æ•¸
if (imageId) {
  const image = await Image.findById(imageId);
  if (image) {
    // é‡æ–°è¨ˆç®—ç•™è¨€ç¸½æ•¸
    const totalComments = await Comment.countDocuments({ imageId });
    image.commentsCount = totalComments;
    
    // é‡æ–°è¨ˆç®—ç†±é–€åº¦åˆ†æ•¸ï¼ˆåŒ…å«ç•™è¨€æ•¸çš„æ¬Šé‡ï¼‰
    image.popScore = computePopScore(image);
    
    await image.save();
  }
}
```

---

## ğŸ“Š **ç†±é–€åº¦åˆ†æ•¸è¨ˆç®—**

### **`computePopScore` å‡½æ•¸ï¼š**

```javascript
// utils/score.js
export const POP_W_CLICK = 1.0;     // é»æ“Šæ¬Šé‡
export const POP_W_LIKE = 8.0;      // é»è®šæ¬Šé‡
export const POP_W_COMMENT = 2.0;   // ç•™è¨€æ¬Šé‡ âœ…
export const POP_W_COMPLETE = 1.0;  // å®Œæ•´åº¦æ¬Šé‡

export function computePopScore(image) {
  const clicks = image.clicks || 0;
  const likesCount = image.likesCount || 0;
  const commentsCount = image.commentsCount || 0; // âœ… ç•™è¨€æ•¸
  const completenessScore = image.completenessScore || 0;
  
  // è¨ˆç®—æ™‚é–“è¡°æ¸›åŠ æˆ
  const decayedBoost = computeTimeDecayBoost(
    image.initialBoost || 0,
    image.createdAt
  );
  
  // ç¸½åˆ† = é»æ“Š + é»è®š + ç•™è¨€ + å®Œæ•´åº¦ + æ™‚é–“åŠ æˆ
  return (
    clicks * POP_W_CLICK +
    likesCount * POP_W_LIKE +
    commentsCount * POP_W_COMMENT +  // âœ… æ¯æ¢ç•™è¨€ +2 åˆ†
    completenessScore * POP_W_COMPLETE +
    decayedBoost
  );
}
```

---

## ğŸ¯ **ç•™è¨€å°ç†±é–€åº¦çš„å½±éŸ¿**

### **æ¬Šé‡å°æ¯”ï¼š**

| æ“ä½œ | æ¬Šé‡ | èªªæ˜ |
|-----|------|------|
| é»æ“Š | 1.0 | åŸºç¤æ¬Šé‡ |
| ç•™è¨€ | 2.0 | **ä¸­ç­‰æ¬Šé‡** |
| é»è®š | 8.0 | é«˜æ¬Šé‡ |

### **è¨ˆç®—ç¤ºä¾‹ï¼š**

**å‡è¨­ä¸€å¼µåœ–ç‰‡ï¼š**
- é»æ“Šæ•¸ï¼š100
- é»è®šæ•¸ï¼š10
- ç•™è¨€æ•¸ï¼š5 â† **åˆªé™¤ 1 æ¢å¾Œè®Šæˆ 4**
- å®Œæ•´åº¦ï¼š50

**åˆªé™¤å‰ï¼š**
```
popScore = 100Ã—1.0 + 10Ã—8.0 + 5Ã—2.0 + 50Ã—1.0 + boost
         = 100 + 80 + 10 + 50 + boost
         = 240 + boost
```

**åˆªé™¤å¾Œï¼š**
```
popScore = 100Ã—1.0 + 10Ã—8.0 + 4Ã—2.0 + 50Ã—1.0 + boost
         = 100 + 80 + 8 + 50 + boost
         = 238 + boost
```

**å½±éŸ¿ï¼š** -2 åˆ†ï¼ˆ1 æ¢ç•™è¨€çš„æ¬Šé‡ï¼‰

---

## ğŸ“‹ **å®Œæ•´æµç¨‹**

### **ç”¨æˆ¶è‡ªå·±åˆªé™¤ç•™è¨€ï¼š**
```
1. ç”¨æˆ¶é»æ“Šã€Œåˆªé™¤ã€æŒ‰éˆ•
   â†“
2. é©—è­‰æ¬Šé™ï¼ˆä½œè€…æˆ–ç®¡ç†å“¡ï¼‰
   â†“
3. åˆªé™¤ç•™è¨€ï¼ˆåŒ…æ‹¬å›è¦†ï¼‰
   â†“
4. é‡æ–°è¨ˆç®— commentsCount
   â†“
5. é‡æ–°è¨ˆç®— popScore
   â†“
6. ä¿å­˜åœ–ç‰‡è³‡æ–™
   â†“
âœ… å®Œæˆï¼ç†±é–€åº¦åˆ†æ•¸å·²æ›´æ–°
```

### **ç®¡ç†å“¡é€šéæª¢èˆ‰åˆªé™¤ï¼š**
```
1. ç®¡ç†å“¡åœ¨æª¢èˆ‰åˆ—è¡¨é»æ“Šã€Œåˆªé™¤ã€
   â†“
2. èª¿ç”¨ DELETE /api/delete-comment/[commentId]
   â†“
3. é©—è­‰ç®¡ç†å“¡æ¬Šé™
   â†“
4. åˆªé™¤ç•™è¨€ï¼ˆåŒ…æ‹¬å›è¦†ï¼‰
   â†“
5. é‡æ–°è¨ˆç®— commentsCount
   â†“
6. é‡æ–°è¨ˆç®— popScore
   â†“
7. ä¿å­˜åœ–ç‰‡è³‡æ–™
   â†“
8. æ›´æ–°æª¢èˆ‰ç‹€æ…‹ç‚ºã€Œå·²è™•ç½®ã€
   â†“
âœ… å®Œæˆï¼ç†±é–€åº¦åˆ†æ•¸å·²æ›´æ–°
```

---

## ğŸ” **é©—è­‰æ–¹å¼**

### **æ¸¬è©¦æ­¥é©Ÿï¼š**

1. **æŸ¥çœ‹åˆªé™¤å‰çš„åˆ†æ•¸ï¼š**
   ```javascript
   // åœ¨ MongoDB æˆ–é€šé API æŸ¥è©¢
   const image = await Image.findById(imageId);
   console.log('åˆªé™¤å‰ commentsCount:', image.commentsCount);
   console.log('åˆªé™¤å‰ popScore:', image.popScore);
   ```

2. **åˆªé™¤ç•™è¨€ï¼š**
   - é€šéæª¢èˆ‰åˆ—è¡¨åˆªé™¤
   - æˆ–ç”¨æˆ¶è‡ªå·±åˆªé™¤

3. **æŸ¥çœ‹åˆªé™¤å¾Œçš„åˆ†æ•¸ï¼š**
   ```javascript
   const updatedImage = await Image.findById(imageId);
   console.log('åˆªé™¤å¾Œ commentsCount:', updatedImage.commentsCount);
   console.log('åˆªé™¤å¾Œ popScore:', updatedImage.popScore);
   ```

4. **ç¢ºèªå·®ç•°ï¼š**
   ```javascript
   const diff = image.popScore - updatedImage.popScore;
   console.log('åˆ†æ•¸å·®ç•°:', diff); // æ‡‰è©²æ˜¯ 2.0 Ã— åˆªé™¤çš„ç•™è¨€æ•¸
   ```

---

## ğŸ“ˆ **å½±éŸ¿ç¯„åœ**

### **å—å½±éŸ¿çš„æ’åºï¼š**

- âœ… **ç†±é–€æ’åº** - åˆªé™¤ç•™è¨€æœƒé™ä½ç†±é–€åº¦ï¼Œå½±éŸ¿æ’å
- âœ… **é¦–é æ¨è–¦** - ä½¿ç”¨ `popScore` æ’åº
- âœ… **ç›¸ä¼¼åœ–ç‰‡æ¨è–¦** - å¯èƒ½è€ƒæ…® `popScore`

### **ä¸å—å½±éŸ¿çš„æ’åºï¼š**

- âŒ **æœ€æ–°æ’åº** - åªçœ‹ `createdAt`
- âŒ **æœ€èˆŠæ’åº** - åªçœ‹ `createdAt`
- âŒ **éš¨æ©Ÿæ’åº** - éš¨æ©Ÿé¸æ“‡
- âŒ **æœ€å¤šé»è®š** - åªçœ‹ `likesCount`

---

## ğŸŠ **ç¸½çµ**

### **âœ… å·²å¯¦ç¾çš„åŠŸèƒ½ï¼š**

1. **è‡ªå‹•æ›´æ–°ç•™è¨€æ•¸** - åˆªé™¤ç•™è¨€å¾Œè‡ªå‹•é‡æ–°è¨ˆç®—
2. **è‡ªå‹•æ›´æ–°ç†±é–€åº¦** - åŸºæ–¼æ–°çš„ç•™è¨€æ•¸é‡æ–°è¨ˆç®—
3. **åŒæ™‚åˆªé™¤å›è¦†** - é¿å…å­¤å…’ç•™è¨€
4. **æ¬Šé™æ§åˆ¶** - åªæœ‰ä½œè€…æˆ–ç®¡ç†å“¡å¯åˆªé™¤

### **ğŸ“Š ç•™è¨€æ¬Šé‡ï¼š**

- **æ¯æ¢ç•™è¨€ï¼š** +2.0 åˆ†
- **ç›¸å°æ–¼é»è®šï¼š** 1/4 æ¬Šé‡
- **ç›¸å°æ–¼é»æ“Šï¼š** 2 å€æ¬Šé‡

### **ğŸ”’ æ•¸æ“šä¸€è‡´æ€§ï¼š**

- âœ… `commentsCount` èˆ‡å¯¦éš›ç•™è¨€æ•¸åŒæ­¥
- âœ… `popScore` èˆ‡ `commentsCount` åŒæ­¥
- âœ… åˆªé™¤æ“ä½œåŸå­æ€§ä¿è­‰

---

**çµè«–ï¼šåˆªé™¤ç•™è¨€æœƒè‡ªå‹•é™ä½åœ–ç‰‡çš„ç†±é–€åº¦åˆ†æ•¸ï¼Œç³»çµ±å·²ç¶“æ­£ç¢ºå¯¦ç¾äº†é€™å€‹æ©Ÿåˆ¶ï¼** âœ…ğŸ‰


