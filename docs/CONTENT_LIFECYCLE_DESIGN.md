# 內容生命週期管理系統設計文檔

> **狀態：** 預留欄位已添加，功能未啟用  
> **更新日期：** 2025-10-21  
> **預計啟用時機：** 當圖片總量 > 10,000 時  
> **重要：** 本系統**僅適用於圖片**，影片使用不同的管理策略（30天自動刪除 + 永久欄位）

---

## 📋 目錄
1. [系統概述](#系統概述)
2. [資料庫設計](#資料庫設計)
3. [冷藏規則](#冷藏規則)
4. [釘選系統](#釘選系統)
5. [實施階段](#實施階段)

---

## 🎯 系統概述

### 設計目標
- **控制儲存成本**：自動淘汰低價值內容
- **提升內容質量**：讓優質內容更容易被發現
- **用戶自主管理**：提供釘選功能保護重要作品
- **創造收益**：釘選槽位作為付費功能

### 核心概念
```
內容生命週期：
新鮮期(0-30天) → 活躍期(30-90天) → 冷卻期(90-180天) → 冷藏期(180天+) → 歸檔期
    ↓                ↓                 ↓                ↓              ↓
  熱門推薦         正常顯示          降權顯示          隱藏顯示       自動刪除
```

---

## 💾 資料庫設計

### Image Model 和 Video Model 共同欄位

```javascript
// ===== 內容狀態 =====
status: String, // 'active' | 'cold' | 'archived' | 'deleted'
  - active: 正常顯示（預設）
  - cold: 冷藏（降權或隱藏）
  - archived: 歸檔（不顯示，僅直連訪問）
  - deleted: 已刪除（軟刪除）

// ===== 互動數據 =====
viewCount: Number,           // 觀看次數
lastViewedAt: Date,          // 最後觀看時間
lastInteractionAt: Date,     // 最後互動時間（點讚/評論/觀看）

// ===== 冷藏/歸檔時間戳 =====
coldAt: Date,                // 進入冷藏狀態的時間
archivedAt: Date,            // 進入歸檔狀態的時間

// ===== 保護標記 =====
isPinned: Boolean,           // 用戶釘選（永不冷藏）
pinnedAt: Date,              // 釘選時間
isHighQuality: Boolean,      // 高質量標記（永不冷藏）
qualityScore: Number,        // 質量評分 (0-100)

// ===== 管理員功能 =====
adminNotes: String,          // 管理員備註
forceActive: Boolean,        // 強制保持活躍（永不冷藏）
```

### User Model 新增欄位

```javascript
// ===== 內容釘選系統 =====
pinnedContentSlots: Number,      // 可用的釘選槽位總數
purchasedPinnedSlots: Number,    // 已購買的額外槽位（永久）
```

---

## 🧊 冷藏規則

### 影片冷藏條件（較嚴格）

**同時滿足以下所有條件：**
1. ✅ 狀態為 `active`
2. ✅ 上傳時間 > 90 天
3. ✅ 點讚數 < 5
4. ✅ 觀看數 < 50
5. ✅ 最後互動 > 60 天前
6. ❌ 非用戶釘選（`isPinned = false`）
7. ❌ 非高質量（`isHighQuality = false`）
8. ❌ 非強制活躍（`forceActive = false`）

**執行動作：**
```javascript
status = 'cold'
coldAt = new Date()
```

**影響：**
- 在列表中降權顯示或隱藏
- 仍可透過個人頁面訪問
- 不會被刪除

---

### 圖片冷藏條件（較寬鬆）

**同時滿足以下所有條件：**
1. ✅ 狀態為 `active`
2. ✅ 上傳時間 > 180 天（6個月）
3. ✅ 點讚數 < 3
4. ✅ 觀看數 < 30
5. ✅ 最後互動 > 120 天前
6. ✅ 元數據完整度 < 30%（沒有技術參考價值）
7. ❌ 非用戶釘選
8. ❌ 非高質量
9. ❌ 非強制活躍

**為什麼圖片標準更寬鬆？**
- 圖片有技術參考價值（提示詞、參數等）
- 儲存成本較低
- 長期保存有教育意義

---

### 歸檔條件（極嚴格）

**同時滿足：**
1. ✅ 狀態為 `cold`（已冷藏）
2. ✅ 冷藏時間 > 180 天
3. ✅ 冷藏期間零互動
4. ❌ 非用戶釘選

**執行動作：**
```javascript
status = 'archived'
archivedAt = new Date()
```

**影響：**
- 不在任何列表顯示
- 只能透過直接連結訪問
- 6 個月後可自動刪除（釋放儲存）

---

## 📌 釘選系統

### 槽位分配規則

#### 基礎槽位（按等級）
```
LV1-3:  1 個釘選位
LV4-6:  3 個釘選位
LV7-9:  5 個釘選位
LV10:   10 個釘選位
```

#### 購買槽位（點數商城）
```
+1 釘選位（永久） - 100 點
+5 釘選位包（永久） - 400 點（8折優惠）
+10 釘選位包（永久） - 700 點（7折優惠）

最多購買：30 個
```

#### VIP 訂閱加成
```
VIP 期間：額外 +20 個釘選位
訂閱結束：恢復原有數量
已釘選內容：不會自動取消
```

#### 總上限計算
```javascript
總釘選位 = 基礎（等級） + 購買 + VIP加成

理論最大值：10 + 30 + 20 = 60 個
實際常見值：
- 普通用戶：1-3 個
- 活躍用戶：5-10 個
- VIP 用戶：20-30 個
```

### 釘選功能

**用戶可以釘選：**
- 自己上傳的圖片
- 自己上傳的影片
- 跨類型混合釘選

**釘選效果：**
- ✅ 永不被冷藏
- ✅ 永不被歸檔
- ✅ 個人頁面置頂顯示
- ✅ 作為個人作品集展示

**取消釘選：**
- 隨時可以取消
- 釋放槽位給其他內容
- 被取消釘選的內容恢復正常生命週期

---

## 🚀 實施階段

### Phase 0：預留階段（已完成 ✅）
```
時機：現在
內容量：< 1,000

動作：
✅ 資料庫欄位已添加
✅ 索引已建立
✅ default 值已設定
✅ 工具函數已準備

效果：
- 所有內容 status = 'active'
- 不執行任何冷藏邏輯
- 系統正常運行
```

### Phase 1：互動追蹤階段
```
時機：內容量 > 2,000
預計：2-3 個月後

動作：
1. 實施觀看計數 API
2. 記錄 lastViewedAt
3. 更新 lastInteractionAt（點讚/評論時）
4. 計算 qualityScore

效果：
- 開始收集互動數據
- 為未來冷藏判定做準備
```

### Phase 2：釘選功能階段
```
時機：內容量 > 5,000
預計：6-9 個月後

動作：
1. 開發釘選 UI（個人頁面）
2. 建立釘選 API
3. 開放釘選槽位購買
4. VIP 獲得 20 個釘選位

效果：
- 用戶可以保護重要作品
- 創造點數消耗途徑
- 增加 VIP 價值
```

### Phase 3：冷藏機制階段
```
時機：內容量 > 10,000
預計：12-18 個月後

動作：
1. 啟動定時任務（每日掃描）
2. 自動標記 cold 內容
3. 查詢時過濾 cold 內容
4. 提供"顯示冷藏內容"選項

效果：
- 列表顯示更高質量內容
- 減少無效查詢
- 提升用戶體驗
```

### Phase 4：歸檔機制階段
```
時機：內容量 > 50,000 或儲存成本壓力大
預計：2-3 年後

動作：
1. 啟動歸檔掃描
2. 自動歸檔極低價值內容
3. 6 個月後自動刪除歸檔內容
4. 提供批次管理工具

效果：
- 大幅節省儲存成本
- 保持資料庫效能
- 系統可持續運營
```

---

## 🛡️ 保護機制

### 永不冷藏的內容

1. **用戶釘選** (`isPinned = true`)
   - 用戶主動保護的重要作品
   - 不受任何自動冷藏影響

2. **高質量內容** (`isHighQuality = true`)
   - 管理員手動標記
   - 或演算法自動判定（qualityScore > 80）
   
3. **近期有互動**
   - lastInteractionAt 在 30 天內
   - 說明仍有用戶關注

4. **管理員強制保護** (`forceActive = true`)
   - 特殊內容（官方範例、教學素材等）
   - 管理員認為有長期價值

5. **VIP 用戶內容**（可選）
   - VIP 訂閱期間上傳的內容
   - 可設定為永不冷藏

---

## 💰 商業模式

### 釘選槽位銷售

#### 點數商城新增項目
```
【內容管理】
┌─────────────────────────────┐
│ +1 釘選位（永久）           │
│ 保護你的重要作品            │
│ 💎 100 點                   │
└─────────────────────────────┘

┌─────────────────────────────┐
│ +5 釘選位包（永久）         │
│ 建立完整作品集              │
│ 💎 400 點（省 100 點）      │
└─────────────────────────────┘

┌─────────────────────────────┐
│ +10 釘選位包（永久）        │
│ 專業創作者必備              │
│ 💎 700 點（省 300 點）      │
└─────────────────────────────┘
```

#### VIP 訂閱升級
```
現有特權：
✓ 永久釘選播放器
✓ 專屬頭像框
✓ 優先客服

新增特權：
✓ 影片上傳無限制
✓ 20 個內容釘選位
✓ 內容永不冷藏（自動 isHighQuality）
✓ 優先推薦演算法加權
```

---

## 📊 影片上傳限制

### 按等級限制
```
LV1:  10 部影片
LV2:  20 部影片
LV3:  30 部影片
LV4:  40 部影片
LV5:  50 部影片
LV6:  60 部影片
LV7:  70 部影片
LV8:  80 部影片
LV9:  90 部影片
LV10: 100 部影片
VIP:  無限制
```

### 達到上限提示
```
⚠️ 已達上傳上限

你已上傳 30 部影片（LV3 上限）

解鎖更多空間：
• 🗑️ 刪除不需要的影片
• ⬆️ 升級到 LV4 解鎖 40 部
• 💎 訂閱 VIP 解鎖無限上傳
```

---

## 🔧 技術實施

### API 端點（未來開發）

#### 釘選內容
```
POST /api/content/pin
Body: { contentId, contentType: 'image' | 'video' }
Response: { success, pinnedCount, limit }
```

#### 取消釘選
```
DELETE /api/content/pin/:id
Response: { success, pinnedCount }
```

#### 查詢釘選狀態
```
GET /api/content/pinned
Response: { items: [...], count, limit }
```

#### 購買釘選槽位
```
POST /api/store/buy-pinned-slots
Body: { quantity: 1 | 5 | 10 }
Response: { success, newSlots, remainingPoints }
```

### 定時任務（未來實施）

#### 冷藏掃描任務
```
時間：每天凌晨 2:00
頻率：每日
功能：掃描並標記應冷藏的內容
```

#### 歸檔掃描任務
```
時間：每週日凌晨 3:00
頻率：每週
功能：掃描並歸檔極低價值內容
```

#### 自動刪除任務
```
時間：每月 1 日凌晨 4:00
頻率：每月
功能：刪除歸檔超過 6 個月的內容
```

---

## 📈 效能優化

### 查詢優化
```javascript
// 只查詢活躍內容
Image.find({ status: 'active' }).sort({ popScore: -1 });
Video.find({ status: 'active' }).sort({ popScore: -1 });

// 使用索引
- { status: 1, popScore: -1 }
- { status: 1, createdAt: -1 }
- { isPinned: 1, user: 1 }
```

### 快取策略
```javascript
// 快取熱門內容列表（1小時）
// 快取用戶釘選內容（5分鐘）
// 冷藏內容不快取
```

---

## 🎨 UI/UX 設計

### 個人頁面新增功能

#### 釘選管理介面
```
┌─────────────────────────────────────┐
│ 📌 我的釘選作品 (8 / 10)           │
│                                     │
│ [圖片A] [圖片B] [影片A] ...        │
│                                     │
│ 💡 升級到 LV7 可獲得 5 個釘選位    │
│ 💎 購買更多釘選位                  │
└─────────────────────────────────────┘
```

#### 冷藏內容提醒
```
┌─────────────────────────────────────┐
│ ⚠️ 內容管理提醒                     │
│                                     │
│ 你有 5 部影片可能即將被冷藏：       │
│                                     │
│ [ ] 影片A - 0讚 2觀看 (85天前)     │
│ [ ] 影片B - 1讚 8觀看 (92天前)     │
│                                     │
│ [📌 釘選選中的] [🗑️ 刪除選中的]    │
│                                     │
│ 💡 釘選可永久保護作品              │
│    你還有 2 個釘選位可用            │
└─────────────────────────────────────┘
```

### 內容詳情頁新增功能

#### 釘選按鈕
```
┌─────────────────────────┐
│ 📌 釘選此作品           │
│ 保護此作品永不被冷藏     │
│ (8 / 10 個釘選位已使用)  │
└─────────────────────────┘
```

---

## 📝 開發清單

### 已完成 ✅
- [x] Image Model 添加生命週期欄位
- [x] Video Model 添加生命週期欄位
- [x] User Model 添加釘選槽位欄位
- [x] 建立必要索引
- [x] 創建工具函數檔案
- [x] 撰寫設計文檔

### 待開發（Phase 1）
- [ ] 觀看計數 API
- [ ] 互動時間記錄邏輯
- [ ] 質量評分計算

### 待開發（Phase 2）
- [ ] 釘選 UI 組件
- [ ] 釘選/取消釘選 API
- [ ] 釘選槽位購買 API
- [ ] 釘選管理頁面

### 待開發（Phase 3）
- [ ] 冷藏掃描定時任務
- [ ] 冷藏內容查詢過濾
- [ ] 冷藏內容恢復功能
- [ ] 批次管理工具

### 待開發（Phase 4）
- [ ] 歸檔掃描定時任務
- [ ] 自動刪除機制
- [ ] 儲存空間監控
- [ ] 管理員審核工具

---

## 🎯 成功指標

### Phase 1 成功標準
- 90% 內容有準確的 viewCount
- lastInteractionAt 更新及時率 > 95%

### Phase 2 成功標準
- 釘選功能使用率 > 20%
- 釘選槽位購買轉化率 > 5%

### Phase 3 成功標準
- 冷藏內容佔比 < 30%
- 活躍內容平均質量提升 > 20%
- 查詢速度提升 > 30%

### Phase 4 成功標準
- 儲存空間節省 > 40%
- 歸檔錯誤率 < 1%
- 用戶投訴率 < 0.1%

---

## ⚠️ 風險控制

### 防止誤冷藏
1. 多重檢查機制
2. 用戶可隨時恢復
3. 冷藏前 7 天通知用戶
4. 提供申訴機制

### 數據備份
1. 冷藏內容定期備份
2. 歸檔前二次確認
3. 刪除前最後備份
4. 可恢復時間窗口

### 用戶溝通
1. 清晰的規則說明
2. 提前通知機制
3. 透明的執行日誌
4. 完善的幫助文檔

---

## 📖 參考資料

### 類似平台案例
- YouTube：不活躍影片降權
- Instagram：舊貼文自然降權
- Pinterest：低互動內容隱藏

### 最佳實踐
- 給用戶自主控制權（釘選）
- 寬鬆的時間窗口（90-180天）
- 可逆的操作（可恢復）
- 透明的規則（清晰說明）

---

**文檔版本：** v1.0  
**最後更新：** 2025-10-21  
**維護者：** AI Development Team

