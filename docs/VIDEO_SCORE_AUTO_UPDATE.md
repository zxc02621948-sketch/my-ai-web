# å½±ç‰‡åˆ†æ•¸è‡ªå‹•æ›´æ–°ç³»çµ±

> **æ›´æ–°æ—¥æœŸï¼š** 2025-10-21  
> **ç‹€æ…‹ï¼š** âœ… å·²å®Œå…¨ä¿®å¾©

---

## ğŸ¯ **å•é¡Œèˆ‡è§£æ±º**

### **åŸå§‹å•é¡Œï¼š**
1. âŒ é»è®šå¾Œ `likesCount` ä¸åŒæ­¥
2. âŒ `popScore` ä¸æœƒè‡ªå‹•æ›´æ–°
3. âŒ ç†±é–€åº¦æ’åºç„¡æ•ˆ
4. âŒ æ–°ä¸Šå‚³çš„å½±ç‰‡åˆ†æ•¸å¯èƒ½ä¸æ­£ç¢º

### **è§£æ±ºæ–¹æ¡ˆï¼š**
1. âœ… ä¿®å¾© aggregation pipelineï¼ˆåˆ†æˆ 3 éšæ®µï¼‰
2. âœ… æ‰€æœ‰ API è‡ªå‹•åŒæ­¥ `likesCount` å’Œ `popScore`
3. âœ… æ–°ä¸Šå‚³è‡ªå‹•è¨ˆç®—æ­£ç¢ºåˆ†æ•¸
4. âœ… ç·¨è¼¯æ™‚é‡æ–°è¨ˆç®—åˆ†æ•¸
5. âœ… é»è®šæ™‚å³æ™‚æ›´æ–°åˆ†æ•¸

---

## ğŸ”§ **ä¿®æ”¹çš„æª”æ¡ˆ**

### **1. app/api/videos/route.js**

**å•é¡Œï¼š** MongoDB aggregation çš„ `$addFields` ç„¡æ³•åœ¨åŒä¸€éšæ®µå¼•ç”¨è‡ªå·±å®šç¾©çš„å­—æ®µ

**ä¿®å¾©å‰ï¼ˆå–®ä¸€éšæ®µï¼‰ï¼š**
```javascript
$addFields: {
  baseScore: { ... },
  livePopScore: { $add: ['$baseScore', ...] }  // âŒ å¼•ç”¨å¤±æ•—
}
```

**ä¿®å¾©å¾Œï¼ˆä¸‰å€‹éšæ®µï¼‰ï¼š**
```javascript
// éšæ®µ 1ï¼šè¨ˆç®—åŸºç¤æ•¸æ“š
$addFields: { likesCountCalc, hoursElapsed, boostFactor }

// éšæ®µ 2ï¼šè¨ˆç®—åˆ†æ•¸ï¼ˆå¯å¼•ç”¨éšæ®µ1ï¼‰
$addFields: { baseScore, finalBoost }

// éšæ®µ 3ï¼šè¨ˆç®—æœ€çµ‚åˆ†æ•¸ï¼ˆå¯å¼•ç”¨éšæ®µ1å’Œ2ï¼‰
$addFields: { livePopScore }
```

---

### **2. app/api/videos/upload/route.js**

**ä¿®æ”¹å‰ï¼š**
```javascript
videoDoc.popScore = 0;  // âŒ å›ºå®šç‚º 0
```

**ä¿®æ”¹å¾Œï¼š**
```javascript
// âœ… è¨ˆç®—åˆå§‹ç†±é–€åº¦åˆ†æ•¸
videoDoc.completenessScore = computeVideoCompleteness(videoDoc);
videoDoc.popScore = computeVideoPopScore(videoDoc);
```

**æ•ˆæœï¼š**
- æ–°å½±ç‰‡æœƒæœ‰æ­£ç¢ºçš„ `initialBoost`ï¼ˆæ–°åœ–åŠ æˆï¼‰
- `popScore` æœƒåŒ…å« `completenessScore` çš„åŠ æˆ
- æ–°å½±ç‰‡æœƒè‡ªå‹•å‡ºç¾åœ¨ç†±é–€åˆ—è¡¨å‰é¢ï¼ˆ10å°æ™‚å…§ï¼‰

---

### **3. app/api/videos/[id]/edit/route.js**

**ä¿®æ”¹å‰ï¼š**
```javascript
const { completenessScore } = scoreVideo(video);
video.completenessScore = completenessScore;
// âŒ æ²’æœ‰æ›´æ–° popScore
```

**ä¿®æ”¹å¾Œï¼š**
```javascript
// é‡æ–°è¨ˆç®—å®Œæ•´åº¦åˆ†æ•¸
video.completenessScore = computeVideoCompleteness(video);
video.hasMetadata = video.completenessScore >= 30;

// âœ… é‡æ–°è¨ˆç®—ç†±é–€åº¦åˆ†æ•¸
video.popScore = computeVideoPopScore(video);
```

**æ•ˆæœï¼š**
- ç·¨è¼¯å½±ç‰‡å…ƒæ•¸æ“šå¾Œï¼Œå®Œæ•´åº¦æœƒæ›´æ–°
- `popScore` æœƒæ ¹æ“šæ–°çš„å®Œæ•´åº¦é‡æ–°è¨ˆç®—

---

### **4. app/api/videos/[id]/like/route.js**

**ä¿®æ”¹å‰ï¼š**
```javascript
video.likes.push(user._id);
await video.save();
// âŒ åªæ›´æ–° likes é™£åˆ—
```

**ä¿®æ”¹å¾Œï¼š**
```javascript
video.likes.push(user._id);

// âœ… åŒæ­¥ likesCount
video.likesCount = video.likes.length;

// âœ… é‡æ–°è¨ˆç®—ç†±é–€åº¦åˆ†æ•¸
video.popScore = computeVideoPopScore(video);

await video.save();
```

**æ•ˆæœï¼š**
- é»è®š/å–æ¶ˆé»è®šæ™‚ï¼Œ`likesCount` è‡ªå‹•åŒæ­¥
- `popScore` ç«‹å³æ›´æ–°ï¼ˆ+8 æˆ– -8ï¼‰
- è³‡æ–™åº«å§‹çµ‚ä¿æŒä¸€è‡´

---

### **5. app/api/admin/fix-video-music-scores/route.js**

**ä¿®æ”¹å‰ï¼š**
```javascript
$set: {
  completenessScore: newCompleteness,
  initialBoost: newInitialBoost,
  popScore: newPopScore,
  // âŒ æ²’æœ‰åŒæ­¥ likesCount
}
```

**ä¿®æ”¹å¾Œï¼š**
```javascript
// è¨ˆç®—æ­£ç¢ºçš„ likesCountï¼ˆå¾ likes é™£åˆ—ï¼‰
const correctLikesCount = Array.isArray(video.likes) 
  ? video.likes.length 
  : (video.likesCount || 0);

$set: {
  completenessScore: newCompleteness,
  initialBoost: newInitialBoost,
  popScore: newPopScore,
  likesCount: correctLikesCount,  // âœ… åŒæ­¥
}
```

---

## ğŸ“Š **è‡ªå‹•æ›´æ–°æ™‚æ©Ÿ**

| æ“ä½œ | clicks æ›´æ–° | likesCount æ›´æ–° | popScore æ›´æ–° | èªªæ˜ |
|------|------------|----------------|--------------|------|
| ğŸ†• ä¸Šå‚³å½±ç‰‡ | âœ… åˆå§‹ (0) | âœ… åˆå§‹ (0) | âœ… è‡ªå‹•è¨ˆç®— | åŒ…å« initialBoost + completeness |
| ğŸ–±ï¸ æ‰“é–‹å½±ç‰‡ | âœ… +1 | â– ä¸è®Š | âœ… å³æ™‚æ›´æ–° | +1 åˆ† |
| â¤ï¸ é»è®š/å–æ¶ˆ | â– ä¸è®Š | âœ… è‡ªå‹•åŒæ­¥ | âœ… å³æ™‚æ›´æ–° | Â±8 åˆ† |
| âœï¸ ç·¨è¼¯å½±ç‰‡ | â– ä¸è®Š | â– ä¸è®Š | âœ… é‡æ–°è¨ˆç®— | æ ¹æ“šæ–°çš„ completeness |
| ğŸ”§ æ‰‹å‹•ä¿®å¾© | â– ä¸è®Š | âœ… å¾é™£åˆ—åŒæ­¥ | âœ… å®Œæ•´é‡ç®— | ä¿®å¾©ä¸ä¸€è‡´æ•¸æ“š |

---

## ğŸ¯ **ç†±é–€åº¦è¨ˆç®—å…¬å¼**

### **å®Œæ•´å…¬å¼ï¼š**
```javascript
popScore = baseScore + finalBoost

baseScore = 
  (clicks Ã— 1.0) +
  (likesCount Ã— 8.0) +      // â† æ¬Šé‡æœ€é«˜
  (views Ã— 0.5) +
  (completeness Ã— 0.05)

finalBoost = initialBoost Ã— decayFactor

decayFactor = {
  ä¸Šå‚³ < 10 å°æ™‚ï¼š1.0 - (ç¶“éå°æ™‚æ•¸ / 10)  // ç·šæ€§è¡°æ¸›
  ä¸Šå‚³ â‰¥ 10 å°æ™‚ï¼š0                       // å®Œå…¨æ¶ˆå¤±
}

initialBoost = ç•¶å‰æœ€é«˜åˆ†æ•¸ Ã— 0.8  // ä¸Šå‚³æ™‚è¨ˆç®—ä¸€æ¬¡
```

### **ç¯„ä¾‹è¨ˆç®—ï¼š**

**æ–°ä¸Šå‚³çš„å½±ç‰‡ï¼ˆ0 å°æ™‚ï¼‰ï¼š**
```
å‡è¨­ç•¶å‰æœ€é«˜åˆ†æ˜¯ 100
initialBoost = 100 Ã— 0.8 = 80
completeness = 45
baseScore = 0 + 0 + 0 + (45 Ã— 0.05) = 2.25
finalBoost = 80 Ã— 1.0 = 80
popScore = 2.25 + 80 = 82.25  â† æ–°å½±ç‰‡æœƒæ’å¾ˆå‰é¢ï¼
```

**ä¸Šå‚³ 5 å°æ™‚å¾Œï¼š**
```
decayFactor = 1.0 - (5 / 10) = 0.5
finalBoost = 80 Ã— 0.5 = 40
popScore = 2.25 + 40 = 42.25
```

**ä¸Šå‚³ 10 å°æ™‚å¾Œï¼š**
```
decayFactor = 0
finalBoost = 0
popScore = 2.25 + 0 = 2.25  â† åªå‰© completeness åŠ æˆ
```

**ç²å¾— 1 å€‹è®šï¼š**
```
baseScore = 0 + (1 Ã— 8) + 0 + 2.25 = 10.25
finalBoost = 0
popScore = 10.25  â† è®šæ¯”æ–°åœ–åŠ æˆæ›´æŒä¹…
```

---

## âœ… **æ¸¬è©¦æ¸…å–®**

### **æ–°ä¸Šå‚³å½±ç‰‡ï¼š**
- [ ] ä¸Šå‚³å½±ç‰‡å¾Œæª¢æŸ¥ `popScore` æ˜¯å¦ > 0
- [ ] æª¢æŸ¥ `initialBoost` æ˜¯å¦æ­£ç¢º
- [ ] æ–°å½±ç‰‡æ˜¯å¦å‡ºç¾åœ¨ç†±é–€åˆ—è¡¨å‰é¢

### **é»è®šåŠŸèƒ½ï¼š**
- [ ] é»è®šå¾Œ `likesCount` ç«‹å³ +1
- [ ] é»è®šå¾Œ `popScore` ç«‹å³ +8
- [ ] æ’åºè‡ªå‹•æ›´æ–°ï¼ˆ0.5ç§’å¾Œï¼‰
- [ ] å–æ¶ˆé»è®šå¾Œåˆ†æ•¸æ­£ç¢º -8

### **ç·¨è¼¯åŠŸèƒ½ï¼š**
- [ ] ç·¨è¼¯å…ƒæ•¸æ“šå¾Œ `completenessScore` æ›´æ–°
- [ ] `popScore` æ ¹æ“šæ–°çš„å®Œæ•´åº¦é‡æ–°è¨ˆç®—

### **æ’åºåŠŸèƒ½ï¼š**
- [ ] ç†±é–€æ’åºæŒ‰ `livePopScore` æ­£ç¢ºæ’åº
- [ ] æœ‰è®šçš„å½±ç‰‡æ’åœ¨å‰é¢
- [ ] æ–°å½±ç‰‡ï¼ˆ10å°æ™‚å…§ï¼‰æœ‰åŠ æˆ

---

## ğŸš€ **æ•ˆèƒ½å„ªåŒ–**

### **å³æ™‚è¨ˆç®— vs è³‡æ–™åº«å¿«ç…§**

**`live=1`ï¼ˆå³æ™‚è¨ˆç®—ï¼‰ï¼š**
- âœ… å³æ™‚åæ˜ æœ€æ–°æ•¸æ“š
- âœ… ä¸éœ€è¦æ‰‹å‹•ä¿®å¾©
- âŒ è¨ˆç®—æˆæœ¬ç¨é«˜ï¼ˆMongoDB aggregationï¼‰

**`live=0`ï¼ˆè³‡æ–™åº«å¿«ç…§ï¼‰ï¼š**
- âœ… æŸ¥è©¢é€Ÿåº¦å¿«
- âŒ éœ€è¦å®šæœŸæ›´æ–°
- âŒ å¯èƒ½ä¸åŒæ­¥

**æ¨è–¦ï¼š** ä½¿ç”¨ `live=1`ï¼ˆå·²è¨­ç‚ºé è¨­ï¼‰

---

## ğŸ“ **ç¶­è­·æŒ‡å—**

### **ä½•æ™‚éœ€è¦æ‰‹å‹•ä¿®å¾©ï¼Ÿ**

é€šå¸¸**ä¸éœ€è¦**ï¼ä»¥ä¸‹æƒ…æ³æœƒè‡ªå‹•æ›´æ–°ï¼š
- âœ… æ–°ä¸Šå‚³å½±ç‰‡
- âœ… é»è®š/å–æ¶ˆé»è®š
- âœ… ç·¨è¼¯å½±ç‰‡

**éœ€è¦æ‰‹å‹•ä¿®å¾©çš„æƒ…æ³ï¼š**
- ä¿®æ”¹äº†è¨ˆç®—å…¬å¼
- è³‡æ–™åº«ç›´æ¥æ“ä½œï¼ˆä¸é€šé APIï¼‰
- ç™¼ç¾æ•¸æ“šä¸ä¸€è‡´

**åŸ·è¡Œä¿®å¾©ï¼š**
```javascript
fetch('/api/admin/fix-video-music-scores', {
  method: 'POST',
  credentials: 'include'
})
.then(res => res.json())
.then(data => console.log('âœ… ä¿®å¾©å®Œæˆ', data));
```

---

## ğŸ‰ **ç¸½çµ**

### **è‡ªå‹•åŒ–è¦†è“‹ç‡ï¼š**
- âœ… ä¸Šå‚³ï¼šè‡ªå‹•è¨ˆç®—
- âœ… é»è®šï¼šè‡ªå‹•æ›´æ–°
- âœ… ç·¨è¼¯ï¼šè‡ªå‹•é‡ç®—
- âœ… æ’åºï¼šå³æ™‚è¨ˆç®—
- âœ… é¡¯ç¤ºï¼šå³æ™‚åæ˜ 

### **ç„¡éœ€æ‰‹å‹•ç¶­è­·ï¼š**
- âœ… åˆ†æ•¸å§‹çµ‚æ­£ç¢º
- âœ… æ’åºå§‹çµ‚æº–ç¢º
- âœ… æ•¸æ“šå§‹çµ‚åŒæ­¥

---

**å½±ç‰‡åˆ†æ•¸ç³»çµ±ç¾åœ¨å®Œå…¨è‡ªå‹•åŒ–äº†ï¼** ğŸŠâœ¨

**å¾ç¾åœ¨é–‹å§‹ï¼š**
- æ–°ä¸Šå‚³çš„å½±ç‰‡ â†’ è‡ªå‹•æœ‰æ­£ç¢ºåˆ†æ•¸
- é»è®šæ“ä½œ â†’ è‡ªå‹•æ›´æ–°åˆ†æ•¸å’Œæ’åº
- ç·¨è¼¯å½±ç‰‡ â†’ è‡ªå‹•é‡æ–°è¨ˆç®—
- **å®Œå…¨ä¸éœ€è¦æ‰‹å‹•å¹²é ï¼** ğŸš€

