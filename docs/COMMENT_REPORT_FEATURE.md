# 留言檢舉功能

> **更新日期：** 2025-10-22  
> **新增：** 圖片留言檢舉功能

---

## 🎯 **功能概述**

### **為什麼用檢舉取代黑名單？**

**黑名單問題：**
- ❌ 太嚴格，可能誤傷正常使用（如「沙發」「頭香」）
- ❌ 無法應對變化的灌水手法
- ❌ 缺乏靈活性，一刀切的規則不適合社群

**檢舉機制優勢：**
- ✅ 社群自治，由用戶和管理員共同維護
- ✅ 靈活處理，可根據具體情況判斷
- ✅ 不誤傷，正常使用不受影響
- ✅ 可擴展，支持多種檢舉類型

---

## 🛡️ **多層防護體系**

### **第 1 層：技術防刷** ✅

```
1. 內容長度：2-500 字
2. 純數字/符號過濾：禁止「11」「666」「!!!」
3. 全局間隔：3 秒
4. 單圖間隔：10 秒
5. 重複檢查：最近 5 條不能相同
6. 每日上限：50 條（VIP 100）
7. 單圖上限：20 條/用戶
```

**作用：** 阻止大規模自動化刷留言

---

### **第 2 層：社群檢舉** ✅ 新增

```
1. 用戶檢舉 → 管理員審核
2. 靈活處理，不誤傷正常使用
3. 支持多種檢舉類型（灌水、辱罵、廣告等）
```

**作用：** 處理技術防刷無法覆蓋的情況

---

## 📋 **檢舉功能詳細說明**

### **1. 檢舉入口**

**位置：** 每條留言下方

**顯示條件：**
- ✅ 用戶已登入
- ✅ 不是自己的留言（不能檢舉自己）

**視覺樣式：**
```
┌────────────────────────────────┐
│ 🕒 3 分鐘前  回覆  🚩 檢舉    │
└────────────────────────────────┘
```

---

### **2. 檢舉流程**

#### **Step 1: 點擊「檢舉」**
```
用戶點擊「🚩 檢舉」按鈕
↓
彈出「檢舉留言」對話框
```

#### **Step 2: 填寫檢舉原因**
```
┌─────────────────────────────────┐
│  檢舉留言                        │
├─────────────────────────────────┤
│  請說明檢舉原因，我們會盡快審核處理  │
│                                 │
│  ┌──────────────────────────┐  │
│  │ 這是灌水留言               │  │
│  │                           │  │
│  └──────────────────────────┘  │
│                                 │
│     [取消]    [提交檢舉]        │
└─────────────────────────────────┘
```

#### **Step 3: 提交成功**
```
┌─────────────────────────────────┐
│  ✅ 檢舉成功                     │
├─────────────────────────────────┤
│  檢舉已提交，管理員將會審核。     │
│  感謝你協助維護社群品質！         │
│                                 │
│          [確定]                 │
└─────────────────────────────────┘
```

---

### **3. 檢舉 API**

**端點：** `POST /api/reports`

**請求體：**
```json
{
  "type": "image_comment",
  "targetId": "68f851776e2aa0227ed031dc",
  "reason": "這是灌水留言",
  "details": "11"
}
```

**響應：**
```json
{
  "ok": true,
  "message": "檢舉已提交"
}
```

---

## 🎯 **技術實現**

### **1. 檢舉按鈕（CommentItem.jsx）**

```jsx
{/* 檢舉按鈕 */}
{currentUser && currentUser?._id !== comment?.userId && onReport && (
  <button
    onClick={() => onReport(comment?._id, comment?.text)}
    className="text-xs text-gray-400 hover:text-yellow-500 transition flex items-center gap-1"
    title="檢舉留言"
  >
    <Flag size={12} />
    檢舉
  </button>
)}
```

**邏輯：**
- 用戶已登入 → 顯示
- 是自己的留言 → 隱藏
- `onReport` 存在 → 顯示

---

### **2. 檢舉處理（CommentBox.jsx）**

```jsx
const handleReport = (commentId, commentContent) => {
  if (!currentUser) {
    setNotification({ 
      isOpen: true, 
      type: 'error', 
      title: '請先登入', 
      message: '您需要登入才能檢舉內容' 
    });
    return;
  }
  setReportModal({ isOpen: true, commentId, content: commentContent });
};

const submitReport = async (reason) => {
  try {
    const response = await fetch('/api/reports', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        type: 'image_comment',
        targetId: reportModal.commentId,
        reason: reason,
        details: reportModal.content
      })
    });

    const result = await response.json();

    if (result.ok || result.success) {
      setNotification({ 
        isOpen: true, 
        type: 'success', 
        title: '檢舉成功', 
        message: '檢舉已提交，管理員將會審核。感謝你協助維護社群品質！' 
      });
      setReportModal({ isOpen: false, commentId: null, content: '' });
    } else {
      setNotification({ 
        isOpen: true, 
        type: 'error', 
        title: '檢舉失敗', 
        message: result.message || result.error || '檢舉失敗，請稍後再試' 
      });
    }
  } catch (error) {
    console.error('檢舉錯誤:', error);
    setNotification({ 
      isOpen: true, 
      type: 'error', 
      title: '檢舉失敗', 
      message: '網路錯誤，請稍後再試' 
    });
  }
};
```

---

### **3. 檢舉類型**

**目前支持：**

| 檢舉類型 | `type` 值 | 適用範圍 |
|---------|----------|---------|
| 圖片留言 | `image_comment` | 圖片頁面留言區 |
| 討論區留言 | `discussion_comment` | 討論區留言 |
| 圖片 | `image` | 圖片本身（已有 `ReportButton`） |

**未來可擴展：**
- 影片留言 (`video_comment`)
- 音樂留言 (`music_comment`)
- 用戶檔案 (`user_profile`)

---

## 🎨 **UI/UX 設計**

### **1. 按鈕位置**

**位置：** 留言下方，與「回覆」並列

```
┌────────────────────────────────────────┐
│  這張圖片超讚！                          │
│  🕒 3 分鐘前   回覆   🚩 檢舉          │
└────────────────────────────────────────┘
```

---

### **2. 顏色設計**

| 狀態 | 顏色 | 說明 |
|-----|------|------|
| 預設 | `text-gray-400` | 低調，不干擾正常閱讀 |
| Hover | `text-yellow-500` | 警告色，表示「檢舉」 |

---

### **3. 彈窗設計**

**使用組件：**
- `ReportModal`：檢舉對話框
- `NotificationModal`：結果通知

**特點：**
- 清晰的標題和說明
- 必填的原因輸入框
- 友好的成功/失敗提示

---

## 📊 **檢舉管理（管理員端）**

### **待實現功能：**

1. **檢舉列表**
   - 查看所有檢舉
   - 按時間/類型/狀態過濾

2. **檢舉審核**
   - 查看檢舉詳情（原始留言、檢舉原因）
   - 快速跳轉到原始內容
   - 審核結果：通過/駁回

3. **處理動作**
   - 刪除留言
   - 警告用戶
   - 封禁用戶（暫時/永久）
   - 標記為誤報

4. **統計分析**
   - 最常被檢舉的用戶
   - 最常被檢舉的內容類型
   - 檢舉處理效率

---

## 🔒 **安全考慮**

### **防濫用機制：**

1. **檢舉限制（待實現）**
   ```
   - 每日檢舉上限：10 次
   - 同一留言只能檢舉 1 次
   - 誤報過多會降低檢舉權重
   ```

2. **誤報懲罰（待實現）**
   ```
   - 3 次誤報 → 警告
   - 5 次誤報 → 暫時停權檢舉功能
   - 10 次誤報 → 永久停權檢舉功能
   ```

3. **惡意檢舉偵測（待實現）**
   ```
   - 檢測特定用戶針對性檢舉
   - 檢測批量檢舉行為
   - 自動標記可疑檢舉
   ```

---

## ✅ **當前狀態**

### **已實現：**
- ✅ 檢舉按鈕（圖片留言）
- ✅ 檢舉彈窗（輸入原因）
- ✅ 檢舉 API（提交到後端）
- ✅ 成功/失敗通知
- ✅ 權限控制（登入、不能檢舉自己）
- ✅ 遞迴傳遞（主留言和回覆都支持）

### **待實現：**
- ⏳ 管理員審核介面
- ⏳ 檢舉列表和統計
- ⏳ 防濫用機制
- ⏳ 影片/音樂留言檢舉

---

## 🎊 **完整的防護體系**

```
技術防刷（第 1 層）
  ├─ 純數字/符號過濾 → 阻止「11」「666」
  ├─ 時間間隔限制 → 阻止快速連發
  ├─ 重複檢查 → 阻止複製貼上
  └─ 數量限制 → 阻止大規模刷留言
            ↓
         成本極高
            ↓
社群檢舉（第 2 層）✅ 新增
  ├─ 用戶發現灌水/辱罵/廣告 → 檢舉
  ├─ 管理員審核 → 刪除/警告/封禁
  └─ 社群自治 → 靈活、不誤傷
            ↓
         高質量社群
```

---

## 🎯 **總結**

**技術防刷 + 社群檢舉 = 最佳方案**

| 方法 | 優點 | 缺點 | 適用 |
|-----|------|------|------|
| 黑名單 | 簡單 | 太嚴格，誤傷 | ❌ 不推薦 |
| 技術防刷 | 自動化，阻止大規模 | 無法處理邊緣案例 | ✅ 第 1 層 |
| 社群檢舉 | 靈活，不誤傷 | 需人工審核 | ✅ 第 2 層 |

**現在的方案：**
- ✅ 純數字/符號過濾（阻止「11」「666」）
- ✅ 時間間隔 + 重複檢查（阻止快速連發）
- ✅ 社群檢舉（處理邊緣案例）
- ✅ 不使用文字黑名單（避免誤傷）

---

**完美的平衡：技術 + 社群！** 🎉🛡️✨

