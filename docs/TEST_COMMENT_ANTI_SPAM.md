# 留言防刷機制測試指南

> **目的：** 驗證所有防刷機制正常運作

---

## 🧪 **測試清單**

### **✅ 測試 1：內容長度限制**

#### **1a. 留言太短（< 2 字）**
```
操作：輸入「a」並發送
預期：❌ 顯示「留言至少需要 2 個字」
狀態：[ ] 通過
```

#### **1b. 留言正常長度**
```
操作：輸入「很棒的作品」並發送
預期：✅ 留言成功
狀態：[ ] 通過
```

#### **1c. 留言太長（> 500 字）**
```
操作：輸入 501 個字並發送
預期：❌ 顯示「留言最多 500 個字」
狀態：[ ] 通過
```

---

### **✅ 測試 2：全局間隔限制（3秒）**

#### **2a. 快速連續留言**
```
操作：
1. 在圖片 A 留言「第一條」
2. 立即在圖片 B 留言「第二條」

預期：❌ 顯示「請等待 3 秒後再留言」
狀態：[ ] 通過
```

#### **2b. 等待後留言**
```
操作：
1. 在圖片 A 留言
2. 等待 3 秒
3. 在圖片 B 留言

預期：✅ 第二條留言成功
狀態：[ ] 通過
```

---

### **✅ 測試 3：同圖間隔限制（10秒）**

#### **3a. 快速在同圖留言**
```
操作：
1. 在圖片 A 留言「第一條」
2. 等待 5 秒
3. 在圖片 A 再留言「第二條」

預期：❌ 顯示「請等待 X 秒後再對此圖片留言」
狀態：[ ] 通過
```

#### **3b. 等待後在同圖留言**
```
操作：
1. 在圖片 A 留言
2. 等待 10 秒
3. 在圖片 A 再留言

預期：✅ 第二條留言成功
狀態：[ ] 通過
```

---

### **✅ 測試 4：重複內容檢測**

#### **4a. 重複留言**
```
操作：
1. 留言「好看」
2. 等待 3 秒
3. 在另一張圖也留言「好看」

預期：❌ 顯示「請不要重複發送相同的留言」
狀態：[ ] 通過
```

#### **4b. 不同內容**
```
操作：
1. 留言「好看」
2. 等待 3 秒
3. 留言「很好看」

預期：✅ 留言成功
狀態：[ ] 通過
```

---

### **✅ 測試 5：每日上限**

#### **5a. 達到上限**
```
操作：
1. 留言 50 條（普通用戶）
2. 嘗試留言第 51 條

預期：❌ 顯示「今日留言已達上限（50 條）」
狀態：[ ] 通過（需要大量操作，可選）
```

#### **5b. VIP 用戶**
```
操作：
1. VIP 用戶留言 50 條
2. 嘗試留言第 51 條

預期：✅ 留言成功（VIP 限制是 100 條）
狀態：[ ] 通過（可選）
```

---

### **✅ 測試 6：單圖上限**

#### **6a. 達到單圖上限**
```
操作：
1. 在圖片 A 留言 20 條
2. 嘗試留言第 21 條

預期：❌ 顯示「你在此圖片的留言已達上限（20 條）」
狀態：[ ] 通過（需要大量操作，可選）
```

---

### **✅ 測試 7：分數更新**

#### **7a. 留言增加分數**
```
操作：
1. 查詢圖片初始分數
2. 發布 1 條留言
3. 再次查詢分數

預期：
✅ commentsCount = 1
✅ popScore 增加 2 分
狀態：[ ] 通過
```

**檢查腳本：**
```javascript
// 步驟 1：查詢初始分數
fetch('/api/images?page=1&limit=5')
  .then(res => res.json())
  .then(data => {
    const img = data.images[0];
    console.log('留言前:');
    console.log('  commentsCount:', img.commentsCount || 0);
    console.log('  popScore:', img.popScore);
    console.log('\n請在此圖片留言，然後等待 3 秒執行下面的代碼');
  });

// 步驟 2：留言後查詢（等待 3 秒後執行）
setTimeout(() => {
  fetch('/api/images?page=1&limit=5')
    .then(res => res.json())
    .then(data => {
      const img = data.images[0];
      console.log('留言後:');
      console.log('  commentsCount:', img.commentsCount);
      console.log('  popScore:', img.popScore);
      console.log('  分數增加:', (img.popScore - 之前的分數));
      console.log('  預期增加: +2');
    });
}, 3000);
```

---

## 🎯 **核心測試（必做）**

### **最小測試組合：**

1. ✅ **內容太短** - 輸入 1 個字 → 應該被拒絕
2. ✅ **全局間隔** - 連續留言 → 應該被限制 3 秒
3. ✅ **重複內容** - 發送相同內容 → 應該被拒絕
4. ✅ **分數更新** - 留言後分數應該 +2

**時間：** 約 1 分鐘

---

## 📊 **預期結果總結**

### **防刷機制啟用後：**

**正常用戶：**
- ✅ 體驗幾乎無影響（3-10秒間隔自然滿足）
- ✅ 留言區質量提升
- ✅ 討論更有深度

**刷留言用戶：**
- ❌ 成本極高（時間、內容、配額）
- ❌ 收益很低（權重只有點讚的 1/4）
- ❌ 得不償失

**系統整體：**
- ✅ 留言區質量大幅提升
- ✅ 熱門度排序更公平
- ✅ 資料庫壓力降低

---

## 🎉 **測試完成標準**

完成以下測試即表示系統正常：

- [ ] 內容長度限制正常工作
- [ ] 全局間隔限制正常工作
- [ ] 同圖間隔限制正常工作
- [ ] 重複內容檢測正常工作
- [ ] 留言後分數正確增加（+2）
- [ ] 錯誤提示清晰友好

---

**所有測試通過後，留言防刷系統就完全可用了！** ✅🛡️

**現在可以開始測試了！** 🧪

