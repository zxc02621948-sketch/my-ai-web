# 影片每日上傳限制功能

> **狀態：** ✅ 已實施  
> **上線日期：** 2025-10-21  

---

## 📋 功能概述

### 限制規則
```
等級制配額（與圖片一致）：
LV1:  5 張/部 每天
LV2:  6 張/部 每天
LV3:  7 張/部 每天
LV4:  8 張/部 每天
LV5:  9 張/部 每天
LV6:  10 張/部 每天
LV7:  11 張/部 每天
LV8:  12 張/部 每天
LV9:  13 張/部 每天
LV10: 14 張/部 每天
VIP:  20 張/部 每天

重置時間：每日 00:00（自動）
適用範圍：圖片和影片使用相同配額系統
```

### 設計目標
- ✅ 控制垃圾內容產出速度
- ✅ 鼓勵用戶提升內容質量
- ✅ 防止批量灌水行為
- ✅ 不限制正常創作（每天 5 部足夠）
- ✅ 增加 VIP 訂閱價值（3倍配額）

---

## 💾 資料庫設計

### User Model 新增欄位
```javascript
dailyVideoUploads: {
  type: Number,
  default: 0,
  comment: '今日已上傳影片數量'
},

lastVideoUploadDate: {
  type: Date,
  default: null,
  comment: '最後上傳影片的日期（用於每日重置）'
},

dailyVideoLimit: {
  type: Number,
  default: 5,
  comment: '每日影片上傳限制'
}
```

---

## 🔧 實施細節

### API 端點

#### 1. 上傳影片 API
**路徑：** `POST /api/videos/upload`

**檢查邏輯：**
```javascript
1. 檢查是否為新的一天
   - 比較 lastVideoUploadDate 與今天
   - 如果是新的一天 → 重置 dailyVideoUploads = 0

2. 計算每日限制
   - VIP 用戶：15 部/天
   - 普通用戶：5 部/天

3. 檢查是否達到上限
   - 如果 dailyVideoUploads >= limit
   - 返回 429 錯誤

4. 上傳成功後
   - dailyVideoUploads += 1
   - lastVideoUploadDate = new Date()
   - 保存用戶資料
```

**返回格式：**
```javascript
// 成功
{
  success: true,
  video: { ... },
  dailyUploads: {
    current: 3,
    limit: 5,
    remaining: 2
  }
}

// 達到上限
{
  error: "今日上傳已達上限（5部）",
  dailyLimit: 5,
  currentCount: 5,
  resetInfo: "明天 00:00 重置配額",
  isVIP: false
}
```

#### 2. 查詢每日配額 API
**路徑：** `GET /api/user/daily-video-quota`

**返回格式：**
```javascript
{
  success: true,
  current: 3,      // 今日已上傳
  limit: 5,        // 每日上限
  remaining: 2,    // 剩餘配額
  isVIP: false,
  resetInfo: "每日 00:00 重置"
}
```

---

## 🎨 UI 顯示

### 上傳 Modal 標題區
```
🎬 上傳影片
最大 20MB，建議 10-20 秒短影片
今日配額：3 / 5 部
```

**配額用完時：**
```
🎬 上傳影片
最大 20MB，建議 10-20 秒短影片
今日配額：5 / 5 部 （已達上限，明天重置）
```

### Toast 提示

**上傳成功：**
```
✅ 影片上傳成功！完整度：45分
今日剩餘：2/5
```

**達到上限：**
```
❌ 今日上傳已達上限（5部）
明天 00:00 重置配額
```

---

## 🎯 VIP 特權

### 每日配額對比
```
普通用戶：5 部/天
VIP 用戶：15 部/天（3倍）

月度對比：
普通用戶：5 × 30 = 150 部/月
VIP 用戶：15 × 30 = 450 部/月
```

### VIP 價值主張
```
VIP 訂閱特權（已更新）：
✓ 每日影片上傳 15 部（普通用戶 5 部）
✓ 永久釘選播放器
✓ 專屬頭像框
✓ 優先客服

→ 對活躍影片創作者：剛需！
```

---

## 📊 預期效果

### 內容質量
```
限制前：
用戶可能一次上傳 20 部 → 質量參差不齊

限制後：
用戶每天只能傳 5 部 → 會選最好的傳
→ 平均質量提升
```

### 用戶行為
```
輕度用戶：
每週傳 2-3 部 → 不受影響 ✅

中度用戶：
每天傳 3-5 部 → 剛好夠用 ✅

重度用戶：
每天想傳 10+ 部 → 訂閱 VIP ✅
```

### 平台成本
```
無限制情況（假設）：
100 個用戶 × 平均 10 部/天 = 1000 部/天
30 天 = 30,000 部/月

每日限制 5 部：
100 個用戶 × 平均 3 部/天 = 300 部/天
30 天 = 9,000 部/月

→ 成本降低 70%！
```

---

## ⚠️ 注意事項

### 時區問題
```
目前使用：new Date().toDateString()
→ 使用伺服器時區

未來考慮：
→ 用戶時區設定
→ 或統一使用 UTC
```

### 重置時機
```
目前：第一次上傳時檢查日期並重置
→ 簡單有效

未來可選：
→ 定時任務每日 00:00 批次重置
→ 但非必要（懶惰重置已足夠）
```

### VIP 判定
```
目前：
hasVIP = subscriptions.some(
  sub => sub.isActive && 
         sub.type === 'premiumFeatures' && 
         sub.expiresAt > now
)

→ 確保只有有效訂閱才能享受特權
```

---

## 🚀 未來擴展

### 可購買的每日配額提升（可選）
```
商城新增：
┌─────────────────────────────┐
│ 每日配額 +5（永久）         │
│ 永久提升你的每日上傳限制     │
│ 💎 500 點                   │
└─────────────────────────────┘

邏輯：
user.dailyVideoLimit = 5 + 購買的提升
```

### 等級制每日配額（可選）
```
LV1-3:  3 部/天
LV4-6:  5 部/天
LV7-9:  8 部/天
LV10:   10 部/天
VIP:    20 部/天

目前：統一 5 部（觀察數據後再決定是否調整）
```

---

## 📈 監控指標

### 需要追蹤的數據
```
1. 每日觸發限制的用戶數
   → 如果 > 20% → 考慮放寬

2. VIP 轉化率
   → 多少用戶因配額不足而訂閱 VIP

3. 平均每日上傳數
   → 如果 < 2 部 → 限制太寬鬆
   → 如果接近 5 部 → 限制合理

4. 內容質量變化
   → 點讚率、觀看率是否提升
```

---

## ✅ 測試檢查清單

- [x] 用戶上傳第 1 部影片 → 計數 1/5
- [x] 用戶上傳第 5 部影片 → 計數 5/5
- [x] 用戶上傳第 6 部影片 → 被拒絕，顯示錯誤
- [x] 隔天上傳 → 計數重置為 1/5
- [x] VIP 用戶上傳 → 限制為 15 部
- [x] Modal 顯示當前配額
- [x] 上傳成功後配額更新

---

**功能已完整實施！** 🚀

