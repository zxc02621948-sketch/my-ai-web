# 🧪 訂閱系統測試指南

## 🎯 測試目標

驗證整個積分月租訂閱系統是否正常運作。

---

## 📋 測試方案

### 🧪 **測試方案（1 分鐘週期）**
- 商品：釘選播放器（測試方案 - 1分鐘）
- 費用：**10 積分/次**
- 週期：**1 分鐘**（而不是 30 天）
- 用途：快速測試自動續費和扣款邏輯

### 📌 **正式方案（30 天週期）**
- 商品：釘選播放器（月租）
- 費用：**100 積分/月**
- 週期：**30 天**
- 用途：公開後的正式功能

---

## 🧪 完整測試流程

### 測試 1：開通測試訂閱（自動續費）

#### 步驟：
1. **確保積分 ≥ 30**（至少能續費 3 次）
2. 前往 `/store`
3. 點擊「功能解鎖」
4. 找到「🧪 釘選播放器（測試方案 - 1分鐘）」
5. **勾選「✨ 啟用自動續費」**
6. 點擊「開通訂閱」

#### 預期結果：
```
✅ 扣除 10 積分
✅ 顯示訂閱成功
✅ 下次扣款時間：約 1 分鐘後
✅ 可以使用釘選功能
```

---

### 測試 2：驗證釘選功能

#### 步驟：
1. 前往任意用戶頁面（有播放器的）
2. 點擊 📌 按鈕

#### 預期結果：
```
✅ 成功釘選（不會提示需要訂閱）
✅ 跨頁面持續播放
```

---

### 測試 3：查看訂閱狀態

#### 步驟：
1. 前往 `/settings`
2. 查看「📋 我的訂閱」區域

#### 預期結果：
```
✅ 顯示「釘選播放器（測試 - 1分鐘）」
✅ 月費：10 積分/月
✅ 下次扣款：約 1 分鐘後
✅ 自動續費：✅ 已啟用
```

---

### 測試 4：等待自動續費（1 分鐘後）

#### 步驟：
1. **等待 1-2 分鐘**
2. 在終端機運行：
   ```bash
   node scripts/process-subscriptions.js
   ```

#### 預期結果（有足夠積分）：
```
終端機輸出：
✅ 續費成功
- 扣除積分: 10
- 剩餘積分: XXX
- 下次扣款: [1分鐘後]

數據庫變化：
✅ 積分 -10
✅ nextBillingDate 延長 1 分鐘
✅ 新增 PointsTransaction 記錄
✅ 新增續費成功通知
```

#### 預期結果（積分不足）：
```
終端機輸出：
❌ 訂閱已取消（積分不足: X < 10）
✅ 已解除釘選播放器

數據庫變化：
✅ subscription.isActive = false
✅ user.pinnedPlayer = undefined
✅ 新增取消通知
```

---

### 測試 5：切換自動續費

#### 步驟：
1. 在 `/settings` 中
2. 找到訂閱項目
3. **取消勾選「自動續費」**
4. 等待 1 分鐘
5. 運行 `node scripts/process-subscriptions.js`

#### 預期結果：
```
終端機輸出：
❌ 訂閱已取消（未啟用自動續費）
✅ 已解除釘選播放器

數據庫變化：
✅ subscription.isActive = false
✅ user.pinnedPlayer = undefined
✅ 積分未被扣除
✅ 新增到期通知
```

---

### 測試 6：取消訂閱

#### 步驟：
1. 在 `/settings` 或 `/store` 中
2. 點擊「取消訂閱」按鈕
3. 確認

#### 預期結果：
```
✅ 訂閱立即取消
✅ 釘選的播放器自動解除
✅ 訂閱從列表中消失
✅ 再次點擊 📌 時提示需要訂閱
```

---

### 測試 7：未訂閱時嘗試釘選

#### 步驟：
1. 確保沒有訂閱
2. 前往用戶頁面
3. 點擊 📌 按鈕

#### 預期結果：
```
彈出提示：
「釘選播放器需要訂閱才能使用。

💰 每月僅需 100 積分（可通過互動免費獲得）
✨ 支援自動續費

是否前往積分商店開通訂閱？」

點擊「確定」→ 跳轉到 /store
```

---

## 🔧 手動觸發扣款測試

### 方法 1：運行定時任務腳本
```bash
# 方法需要先配置環境變數，暫時不可用
# node scripts/process-subscriptions.js
```

### 方法 2：直接在 MongoDB 中修改時間
```javascript
// 在 MongoDB Compass 或 mongosh 中執行：

db.users.updateOne(
  { username: "p77897" },
  { 
    $set: { 
      "subscriptions.$[sub].nextBillingDate": new Date() 
    } 
  },
  { 
    arrayFilters: [{ "sub.type": "pinPlayerTest", "sub.isActive": true }] 
  }
)

// 然後運行腳本
```

### 方法 3：等待 1 分鐘（測試方案）
```
開通測試訂閱後：
- 等待 1 分鐘
- 刷新設置頁面
- 應該顯示「已過期」或被自動取消
```

---

## 📊 測試檢查清單

### 基本功能
- [ ] 開通訂閱（積分充足）
- [ ] 開通訂閱（積分不足 - 應該失敗）
- [ ] 訂閱後可以釘選播放器
- [ ] 未訂閱時釘選會提示

### 訂閱管理
- [ ] 設置頁面正確顯示訂閱
- [ ] 切換自動續費開關
- [ ] 取消訂閱
- [ ] 取消訂閱後釘選自動解除

### 自動續費（1分鐘測試）
- [ ] 自動續費 + 積分充足 → 續費成功
- [ ] 自動續費 + 積分不足 → 取消訂閱
- [ ] 未啟用自動續費 → 到期取消
- [ ] 取消時釘選自動解除

### UI 狀態
- [ ] 商店商品卡片正確顯示「訂閱中」/「開通訂閱」
- [ ] 設置頁面訂閱狀態正確
- [ ] 自動續費勾選框狀態同步
- [ ] 取消訂閱後 UI 正確更新

---

## ⚠️ 測試注意事項

### 1. 測試方案 vs 正式方案
```
測試方案：
- 用於快速測試
- 1 分鐘週期
- 10 積分/次
- 公開前應該移除或隱藏

正式方案：
- 用於實際使用
- 30 天週期
- 100 積分/月
- 公開後保留
```

### 2. 同時只能有一個釘選訂閱
```
用戶不能同時訂閱：
- 測試方案 + 正式方案

如果已有測試訂閱，應該：
1. 先取消測試訂閱
2. 再訂閱正式方案
```

### 3. 定時任務部署
```
本地測試：
- 手動運行 scripts/process-subscriptions.js

生產環境：
- 需要設置 Vercel Cron Jobs
- 或使用 GitHub Actions 定時任務
- 建議：每小時運行一次（檢測測試方案）
- 生產：每天運行一次（檢測正式方案）
```

---

## 🚀 測試完成後

### 清理工作
- [ ] 測試完成後，決定是否保留測試方案
- [ ] 如果不保留，從 `store-products.js` 中移除
- [ ] 或添加顯示條件（僅開發環境顯示）

### 部署準備
- [ ] 設置生產環境的定時任務
- [ ] 確認通知系統正常運作
- [ ] 準備用戶使用文檔

---

## 💡 快速測試命令

```bash
# 1. 開通測試訂閱（瀏覽器操作）
# 前往 /store → 開通測試方案 → 勾選自動續費

# 2. 等待 1-2 分鐘

# 3. 手動觸發扣款（如果腳本可用）
# node scripts/process-subscriptions.js

# 4. 刷新設置頁面查看結果
```

---

現在可以開始測試了！🎉

